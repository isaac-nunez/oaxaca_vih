---
title: "Oaxaca ONUSIDA"
author: "Isaac Núñez, Yanink Caro Vega"
output:
  word_document: default
  html_document:
    df_print: paged
---

```{r first, include = F, warning=F}
setwd("C:/Users/isaac/OneDrive/Documentos/Protocolos_de_investigacion/Chiapas-Oaxaca ONUSIDA")


```


```{r first chunk, include = F, warning=F}
library(tidyverse);library(lubridate); library(readxl);library(viridis);library(data.table);library(devtools); library(flextable);
library(patchwork); library(rms)
#library(mxmaps)


#capasits_oaxaca <- read_excel("base_oaxaca_21.xlsx")


load("~/Protocolos_de_investigacion/Chiapas-Oaxaca ONUSIDA/chiapas_onusida/oaxaca_vih/capasits_oaxaca.Rda")
#plantilla_capasits <- read_excel("PLANTILLA POR CAPASITS DE OAXACA2.xlsx")
cd4_oaxaca <- read_excel("cd4_oaxaca.xlsx")
cv_oaxaca <- read_excel("carga_viral_oaxaca.xlsx")
```


```{r base capasits oaxaca, include = F, warning=F, run = F}
capasits_oaxaca <- capasits_oaxaca %>% 
  mutate(id_paciente=as.character(id_paciente),
         paciente_ultima_consulta = ymd(paciente_ultima_consulta),
         paciente_notificacion = ymd(paciente_notificacion),
         paciente_ingreso = ymd(paciente_ingreso),
         paciente_fecha_defuncion = ymd(paciente_fecha_defuncion),
         paciente_fecha_alta = ymd(substr(paciente_fecha_alta, 1, 10)),
         paciente_f_ultimo_estatus = ymd(substr(paciente_f_ultimo_estatus, 1, 10)),
         esquema_fecha_inicio = ymd(esquema_fecha_inicio),
         cv_fecha_estudio = ymd(cv_fecha_estudio))

#save(capasits_oaxaca, file="capasits_oaxaca.Rda")

## Análisis exploratorio breve sobre capasits_oaxaca 
glimpse(capasits_oaxaca)
table(capasits_oaxaca$paciente_sexo)
n_distinct(capasits_oaxaca$id_paciente)
range(capasits_oaxaca$paciente_ingreso, na.rm = T)
range(capasits_oaxaca$paciente_f_ultimo_estatus, na.rm = T)
sum(is.na(capasits_oaxaca$paciente_ingreso))
sum(is.na(capasits_oaxaca$paciente_notificacion))
sum(capasits_oaxaca$paciente_estatus=="ACTIVO")

#Pacientes de cd4_oaxaca y cv_oaxaca que están presentes en capasits_oaxaca
n_distinct(filter(cd4_oaxaca, id_paciente%in%capasits_oaxaca$id_paciente)$id_paciente)
n_distinct(filter(cv_oaxaca, id_paciente%in%capasits_oaxaca$id_paciente)$id_paciente)


n_distinct(filter(cd4_oaxaca, id_paciente%in%filter(cv_oaxaca, id_paciente%in%capasits_oaxaca$id_paciente)$id_paciente)$id_paciente)
```


```{r tabla 1, run = F, include = F, warning=F}
#Construiremos las variables que compondrán la tabla por separado para que sea más manejable


#Género de los pacientes
genero_t <- c("Mujer cis", "Hombre cis", "Mujer trans", "Hombre trans", "Todos")

#Tipo de pacientes (todos son en trataimento ARV)
paciente_tipo_t <- c(str_c(sum(capasits_oaxaca$paciente_sexo=="F"), " (", round(sum(capasits_oaxaca$paciente_sexo=="F")/nrow(capasits_oaxaca), 3)*100, "%)"),
                                      str_c(sum(capasits_oaxaca$paciente_sexo=="M"), " (", round(sum(capasits_oaxaca$paciente_sexo=="M")/nrow(capasits_oaxaca), 3)*100, "%)"),
                                      str_c(sum(capasits_oaxaca$paciente_sexo=="TF"), " (", round(sum(capasits_oaxaca$paciente_sexo=="TF")/nrow(capasits_oaxaca), 3)*100, "%)"),
                                      str_c(sum(capasits_oaxaca$paciente_sexo=="TM"), " (", round(sum(capasits_oaxaca$paciente_sexo=="TM")/nrow(capasits_oaxaca), 3)*100, "%)"),
                                      str_c(nrow(capasits_oaxaca), " (100%)"))

#Sexo de los pacientes
paciente_sexo_t <- c(str_c(sum(capasits_oaxaca$paciente_sexo=="F"), " (", round(sum(capasits_oaxaca$paciente_sexo=="F")/nrow(capasits_oaxaca), 3)*100, "%)"),
                                      str_c(sum(capasits_oaxaca$paciente_sexo=="M"), " (", round(sum(capasits_oaxaca$paciente_sexo=="M")/nrow(capasits_oaxaca), 3)*100, "%)"),
                                      str_c(sum(capasits_oaxaca$paciente_sexo=="TF"), " (", round(sum(capasits_oaxaca$paciente_sexo=="TF")/nrow(capasits_oaxaca), 3)*100, "%)"),
                                      str_c(sum(capasits_oaxaca$paciente_sexo=="TM"), " (", round(sum(capasits_oaxaca$paciente_sexo=="TM")/nrow(capasits_oaxaca), 3)*100, "%)"),
                                      str_c(nrow(capasits_oaxaca), " (100%)"))

#Edad de los pacientes (mediana y rango IQR)
paciente_edad_t <- c(str_c(median(filter(capasits_oaxaca, paciente_sexo=="F"&!is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca, paciente_sexo=="F"&!is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca, paciente_sexo=="F"&!is.na(paciente_edad))$paciente_edad)[4], ")"),
                     str_c(median(filter(capasits_oaxaca, paciente_sexo=="F"&!is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca, paciente_sexo=="M"&!is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca, paciente_sexo=="M"&!is.na(paciente_edad))$paciente_edad)[4], ")"),
                     str_c(median(filter(capasits_oaxaca, paciente_sexo=="F"&!is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca, paciente_sexo=="TF"&!is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca, paciente_sexo=="TF"&!is.na(paciente_edad))$paciente_edad)[4], ")"),
                     str_c(median(filter(capasits_oaxaca, paciente_sexo=="F"&!is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca, paciente_sexo=="TM"&!is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca, paciente_sexo=="TM"&!is.na(paciente_edad))$paciente_edad)[4], ")"),
                     str_c(median(filter(capasits_oaxaca, !is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca, !is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca, !is.na(paciente_edad))$paciente_edad)[4], ")"))


#Si la paciente estaba o no embarazada
paciente_embarazada_t <- c(str_c(sum(capasits_oaxaca$paciente_vih_embarazada=="SI"), " (", 
                                                  (round(sum(capasits_oaxaca$paciente_vih_embarazada=="SI")/sum(capasits_oaxaca$paciente_sexo=="F"), 3)*100), "%)"), rep("0 (0%)", times=3),
                                            str_c(sum(capasits_oaxaca$paciente_vih_embarazada=="SI"), " (", 
                                                  (round(sum(capasits_oaxaca$paciente_vih_embarazada=="SI")/nrow(capasits_oaxaca), 3)*100), "%)"))


#Si la paciente estaba privada de su libertad
paciente_privada_t <- c(str_c(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_priv_libertad=="S"), " (", round(sum(capasits_oaxaca$paciente_sexo=="F"&
                                                                                                                                     capasits_oaxaca$paciente_priv_libertad=="S")
                                                                                                                                         /sum(capasits_oaxaca$paciente_sexo=="F"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="M"&
                                                              capasits_oaxaca$paciente_priv_libertad=="S"), " (", round(sum(capasits_oaxaca$paciente_sexo=="M"&
                                                                                                                              capasits_oaxaca$paciente_priv_libertad=="S")
                                                                                                                                         /sum(capasits_oaxaca$paciente_sexo=="M"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TF"&
                                                              capasits_oaxaca$paciente_priv_libertad=="S"), " (", round(sum(capasits_oaxaca$paciente_sexo=="TF"&
                                                                                                                              capasits_oaxaca$paciente_priv_libertad=="S")
                                                                                                                                          /sum(capasits_oaxaca$paciente_sexo=="TF"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TM"&
                                                              capasits_oaxaca$paciente_priv_libertad=="S"), " (", round(sum(capasits_oaxaca$paciente_sexo=="TM"&
                                                                                                                              capasits_oaxaca$paciente_priv_libertad=="S")
                                                                                                                                          /sum(capasits_oaxaca$paciente_sexo=="TM"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_priv_libertad=="S"), " (", round(sum(capasits_oaxaca$paciente_priv_libertad=="S")
                                                                                                                      /nrow(capasits_oaxaca), 3)*100, "%)"))

#Si los pacientes tenían estatus de activo, desglosado por género
paciente_estatus_activo_t <- c(str_c(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_estatus=="ACTIVO"), " (",
                                                      round(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_estatus=="ACTIVO")/sum(capasits_oaxaca$paciente_sexo=="F"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_estatus=="ACTIVO"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_estatus=="ACTIVO")/sum(capasits_oaxaca$paciente_sexo=="M"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_estatus=="ACTIVO"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_estatus=="ACTIVO")/sum(capasits_oaxaca$paciente_sexo=="TF"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_estatus=="ACTIVO"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_estatus=="ACTIVO")/sum(capasits_oaxaca$paciente_sexo=="TM"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_estatus=="ACTIVO"), " (", round(sum(capasits_oaxaca$paciente_estatus=="ACTIVO")
                                                                                                                      /nrow(capasits_oaxaca), 3)*100, "%)"))

#Si los pacientes tenían estatus de baja, desglosado por género
paciente_estatus_baja_t <- c(str_c(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_estatus=="BAJA"), " (",
                                                      round(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_estatus=="BAJA")/sum(capasits_oaxaca$paciente_sexo=="F"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_estatus=="BAJA"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_estatus=="BAJA")/sum(capasits_oaxaca$paciente_sexo=="M"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_estatus=="BAJA"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_estatus=="BAJA")/sum(capasits_oaxaca$paciente_sexo=="TF"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_estatus=="BAJA"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_estatus=="BAJA")/sum(capasits_oaxaca$paciente_sexo=="TM"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_estatus=="BAJA"), " (", round(sum(capasits_oaxaca$paciente_estatus=="BAJA")
                                                                                                                      /nrow(capasits_oaxaca), 3)*100, "%)"))


#Si los pacientes tenían estatus de derivación, desglosado por género

paciente_estatus_derivacion_t <- c(str_c(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (",
                                                      round(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")/sum(capasits_oaxaca$paciente_sexo=="F"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")/sum(capasits_oaxaca$paciente_sexo=="M"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")/sum(capasits_oaxaca$paciente_sexo=="TF"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")/sum(capasits_oaxaca$paciente_sexo=="TM"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (", round(sum(capasits_oaxaca$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")
                                                                                                                      /nrow(capasits_oaxaca), 3)*100, "%)"))


#Si los pacientes tenían estatus de suspensión, desglosado por género
paciente_estatus_suspension_t <- c(str_c(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_estatus=="EN SUSPENSION"), " (",
                                                      round(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_estatus=="EN SUSPENSION")/sum(capasits_oaxaca$paciente_sexo=="F"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_estatus=="EN SUSPENSION"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_estatus=="EN SUSPENSION")/sum(capasits_oaxaca$paciente_sexo=="M"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_estatus=="EN SUSPENSION"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_estatus=="EN SUSPENSION")/sum(capasits_oaxaca$paciente_sexo=="TF"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_estatus=="EN SUSPENSION"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_estatus=="EN SUSPENSION")/sum(capasits_oaxaca$paciente_sexo=="TM"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_estatus=="EN SUSPENSION"), " (", round(sum(capasits_oaxaca$paciente_estatus=="EN SUSPENSION")
                                                                                                                      /nrow(capasits_oaxaca), 3)*100, "%)"))



#Tratamiento para incluir en la tabla
 tratamiento <- group_by(capasits_oaxaca, paciente_sexo, esquema) %>% 
   count() %>% 
   arrange(desc(n)) %>% 
   ungroup() %>% 
   group_by(paciente_sexo) %>% 
   slice(1)

tratamiento_whole <- group_by(capasits_oaxaca, esquema) %>% 
  count() %>% 
  arrange(desc(n)) 


tratamiento_t <- c(str_c(tratamiento$esquema, " ", tratamiento$n), str_c(tratamiento_whole$esquema[1], " ", tratamiento_whole$n[1]))

#Centro en donde reciben la atención
centro_oaxaca <- c(str_c(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_sai=="CAPASITS - Oaxaca"), " (",
                                                      round(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_sai=="CAPASITS - Oaxaca")/sum(capasits_oaxaca$paciente_sexo=="F"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_sai=="CAPASITS - Oaxaca"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_sai=="CAPASITS - Oaxaca")/sum(capasits_oaxaca$paciente_sexo=="M"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_sai=="CAPASITS - Oaxaca"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_sai=="CAPASITS - Oaxaca")/sum(capasits_oaxaca$paciente_sexo=="TF"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_sai=="CAPASITS - Oaxaca"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_sai=="CAPASITS - Oaxaca")/sum(capasits_oaxaca$paciente_sexo=="TM"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sai=="CAPASITS - Oaxaca"), " (", round(sum(capasits_oaxaca$paciente_sai=="CAPASITS - Oaxaca")
                                                                                                                      /nrow(capasits_oaxaca), 3)*100, "%)"))


centro_salina <- c(str_c(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_sai=="CAPASITS - Salina Cruz"), " (",
                                                      round(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_sai=="CAPASITS - Salina Cruz")/sum(capasits_oaxaca$paciente_sexo=="F"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_sai=="CAPASITS - Salina Cruz"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_sai=="CAPASITS - Salina Cruz")/sum(capasits_oaxaca$paciente_sexo=="M"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_sai=="CAPASITS - Salina Cruz"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_sai=="CAPASITS - Salina Cruz")/sum(capasits_oaxaca$paciente_sexo=="TF"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_sai=="CAPASITS - Salina Cruz"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_sai=="CAPASITS - Salina Cruz")/sum(capasits_oaxaca$paciente_sexo=="TM"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sai=="CAPASITS - Salina Cruz"), " (", round(sum(capasits_oaxaca$paciente_sai=="CAPASITS - Salina Cruz")
                                                                                                                      /nrow(capasits_oaxaca), 3)*100, "%)"))


####TABLA 1 
table_1 <- data.frame(genero=genero_t,
                      #####################
                      paciente_tipo=paciente_tipo_t,
                      #####################
                      paciente_sexo=paciente_sexo_t,
                      #####################
                      paciente_edad=paciente_edad_t,
                      #####################
                      paciente_embarazada=paciente_embarazada_t,
                      #####################
                      paciente_privada_libertad=paciente_privada_t,
                      #####################
                      paciente_estatus=rep("-", times=5),
                      #####################
                      paciente_estatus_activo=paciente_estatus_activo_t,
                      #####################
                      paciente_estatus_baja=paciente_estatus_baja_t,
                      #####################
                      paciente_estatus_en_derivacion=paciente_estatus_derivacion_t,
                      #####################
                      paciente_estatus_suspension=paciente_estatus_suspension_t,
                      #####################
                      paciente_tratamiento= tratamiento_t,
                      #####################
                      paciente_centro=rep("-", times=5),
                      #####################
                      paciente_centro_oaxaca= centro_oaxaca,
                      #####################
                      paciente_centro_salina=centro_salina
                      )


View(table_1)


```


Recibimos la base *OAXACA PROYECTO 21*, la cual incluye información sobre todo paciente que recibe atención en el sistema CAPASITS del estado de Oaxaca. De aquí en adelante, nos referiremos a dicha base con el nombre *capasits_oaxaca*, la cual será nuestra base de trabajo. La base cuenta con `r ncol(capasits_oaxaca)` variables y `r nrow(capasits_oaxaca)` observaciones. Las variables incluídas son: `r names(capasits_oaxaca)`. Se encontró un total de `r n_distinct(capasits_oaxaca$id_paciente)` pacientes (únicamente uno con una observación repetida), de los cuales `r sum(capasits_oaxaca$paciente_estatus=="ACTIVO")` se encuentran activos en el sistema CAPASITS (`r round((sum(capasits_oaxaca$paciente_estatus=="ACTIVO")/n_distinct(capasits_oaxaca$id_paciente))*100, 1)`%). Del total de pacientes, `r sum(capasits_oaxaca$paciente_sexo=="F")` son mujeres cis,  `r sum(capasits_oaxaca$paciente_sexo=="M")` son hombres cis, `r sum(capasits_oaxaca$paciente_sexo=="TF")` son mujeres trans y una persona es hombre trans. El rango de fechas de ingreso al sistema CAPASITS fue del `r range(capasits_oaxaca$paciente_ingreso, na.rm = T)[1]` al `r range(capasits_oaxaca$paciente_ingreso, na.rm = T)[2]`. En la **Figura 1A** se muestra el total de pacientes que ingresaron por año, mientras que en la **Figura 1B** se muestra el total de pacientes que ingresaron por año y por género. La fecha en la cual se registró la última consulta fue el `r range(capasits_oaxaca$paciente_f_ultimo_estatus, na.rm = T)[2]`.  

```{r figura 1 a y b, include= F, echo= F, warning=F}

#División únicamente por año
capasits_oaxaca_figura <- capasits_oaxaca %>% 
  mutate(ano_ingreso= factor(year(paciente_ingreso))) %>% 
  group_by(ano_ingreso) %>% 
  count()


capasits_oaxaca_figura_plot <- ggplot(capasits_oaxaca_figura, aes(x= as.integer(n), y=ano_ingreso))+
  geom_segment(aes(yend = ano_ingreso), xend = 0, colour = "grey50")+
  geom_point(size = 3)+
  ggtitle("")+
  theme_bw()+
  ylab("Año de ingreso")+
  xlab("# de pacientes")+
  theme(panel.grid.major.y = element_blank())+
  scale_colour_viridis(discrete=TRUE)
  

#División por sexo
capasits_oaxaca_figura_s <- capasits_oaxaca %>% 
  mutate(ano_ingreso= factor(year(paciente_ingreso)),
         paciente_sexo= case_when(paciente_sexo=="F"~"Mujer cis",
                                  paciente_sexo=="M"~"Hombre cis",
                                  paciente_sexo=="TF"~"Mujer trans",
                                  paciente_sexo=="TM"~"Hombre trans")) %>% 
  group_by(ano_ingreso, paciente_sexo) %>% 
  count()

capasits_oaxaca_figura_plot_s <- ggplot(capasits_oaxaca_figura_s, aes(x= as.integer(n), y=ano_ingreso, colour=paciente_sexo))+
  geom_segment(aes(yend = ano_ingreso), xend = 0, colour = "grey50")+
  geom_point( size = 3)+
  ggtitle("")+
  theme_bw()+
  ylab("")+
  xlab("# de pacientes")+
  theme(panel.grid.major.y = element_blank(),
          legend.title=element_blank(),
        legend.position=c(0.7,0.2))+
scale_colour_viridis(discrete=TRUE)
  
figura_1 <- capasits_oaxaca_figura_plot+capasits_oaxaca_figura_plot_s+plot_annotation(tag_levels='A')


#ggsave(plot = figura_1, width = 6.1, height = 6.5, dpi = 300, filename = "figura_1.png")
```
![Figura 1](figura_1.png)
**Figura 1**. Número de pacientes que ingresaron cada año a CAPASITS Oaxaca en total (A) y desglosado por género (B).
</br>
</br>
</br>
</br>

Se recibieron además dos bases adicionales, las cuales incluyen información sobre todas las mediciones de linfocitos T CD4 y carga viral de VIH realizadas en pacientes de CAPASITS Oaxaca. En la base de linfocitos T CD4 (llamada *cd4_oaxaca*) hay información sobre `r n_distinct(cd4_oaxaca$id_paciente)` pacientes, mientras que en la de carga viral de VIH (llamada *cv_oaxaca*) hay información sobre `r n_distinct(cv_oaxaca$id_paciente)` pacientes. De los pacientes presentes en *capasits_oaxaca*, `r n_distinct(filter(cd4_oaxaca, id_paciente%in%capasits_oaxaca$id_paciente)$id_paciente)` (`r round(n_distinct(filter(cd4_oaxaca, id_paciente%in%capasits_oaxaca$id_paciente)$id_paciente)/n_distinct(capasits_oaxaca$id_paciente), 1)`%) tuvieron información sobre linfocitos T CD4 en la base *cd4_oaxaca*. Asimismo,  `r n_distinct(filter(cv_oaxaca, id_paciente%in%capasits_oaxaca$id_paciente)$id_paciente)` (`r round(n_distinct(filter(cv_oaxaca, id_paciente%in%capasits_oaxaca$id_paciente)$id_paciente)/n_distinct(capasits_oaxaca$id_paciente), 1)`%) tuvieron información sobre carga viral de VIH en *cv_oaxaca*. Todos los pacienes con información sobre carga viral también tuvieron información sobre linfocitos T CD4, de manera que hubo `r n_distinct(filter(cd4_oaxaca, id_paciente%in%capasits_oaxaca$id_paciente)$id_paciente)-n_distinct(filter(cv_oaxaca, id_paciente%in%capasits_oaxaca$id_paciente)$id_paciente)` más pacientes con información sobre linfocitos T CD4. En la **Tabla 1** se describen a detalle las características generales de los pacientes incluidos en la base *capasits_oaxaca*



```{r filtrando bases a pacientes que ingresaron durante 2018 a 2021, include=F, warning=F}
capasits_oaxaca_2018_2021 <- filter(capasits_oaxaca, paciente_ingreso>="2018-01-01")

capasits_oaxaca_2018_2021_not <- filter(capasits_oaxaca, paciente_notificacion>="2018-01-01")

capasits_oaxaca_2018_2019 <- filter(capasits_oaxaca, paciente_ingreso>="2018-01-01"&
                                      paciente_notificacion<="2020-02-27")

capasits_oaxaca_2018_2019_not <- filter(capasits_oaxaca, paciente_notificacion>="2018-01-01"&
                                      paciente_notificacion<="2020-02-27")

capasits_oaxaca_2020_2021 <- filter(capasits_oaxaca, paciente_ingreso>="2020-02-28")

capasits_oaxaca_2020_2021_not <- filter(capasits_oaxaca, paciente_notificacion>="2020-02-28")
```

La base *capasits_oaxaca* se filtró para incluir únicamente a los pacientes ingresados al sistema CAPASITS durante los años 2018 a 2021, resultando en la base *capasits_oaxaca_2018_2021*. Dicha base incluye a `r nrow(capasits_oaxaca_2018_2021)` PVVIH, de los cuales `r sum(capasits_oaxaca_2018_2021$paciente_estatus=="ACTIVO")` se encuentran activos en el sistema CAPASITS (`r round((sum(capasits_oaxaca_2018_2021$paciente_estatus=="ACTIVO")/n_distinct(capasits_oaxaca_2018_2021$id_paciente))*100, 1)`%). Del total de pacientes, `r sum(capasits_oaxaca_2018_2021$paciente_sexo=="F")` son mujeres cis,  `r sum(capasits_oaxaca_2018_2021$paciente_sexo=="M")` son hombres cis, `r sum(capasits_oaxaca_2018_2021$paciente_sexo=="TF")` son mujeres trans y una persona es hombre trans. Un total de `r sum(capasits_oaxaca_2018_2021$paciente_sai=="CAPASITS - Salina Cruz")` (`r round((sum(capasits_oaxaca_2018_2021$paciente_sai=="CAPASITS - Salina Cruz")/nrow(capasits_oaxaca_2018_2021)*100), 1)`%) ingresaron al CAPASITS de Salina Cruz, mientras que `r sum(capasits_oaxaca_2018_2021$paciente_sai=="CAPASITS - Oaxaca")` (`r round((sum(capasits_oaxaca_2018_2021$paciente_sai=="CAPASITS - Oaxaca")/nrow(capasits_oaxaca_2018_2021)*100), 1)`%) ingresaron a la capital del estado. La fecha en la cual se registró la última consulta fue el `r range(capasits_oaxaca_2018_2021$paciente_f_ultimo_estatus, na.rm = T)[2]`. En la **Figura 2A** se muestra el total de pacientes que ingresaron por año y por centro, mientras que en la **Figura 2B** se muestra el total de pacientes que ingresaron también desglosados por género.


```{r figura 2 a y b, include= F, echo= F, warning=F}

#División únicamente por año
capasits_oaxaca_reciente_figura <- capasits_oaxaca_2018_2021 %>% 
  mutate(ano_ingreso= factor(year(paciente_ingreso))) %>% 
  group_by(ano_ingreso, paciente_sai) %>% 
  count()


capasits_oaxaca_reciente_figura <- ggplot(capasits_oaxaca_reciente_figura, aes(x= as.integer(n), y=ano_ingreso, colour=paciente_sai))+
  geom_segment(aes(yend = ano_ingreso), xend = 0, colour = "grey50")+
  geom_point(size = 3)+
  ggtitle("")+
  theme_bw()+
  ylab("Año de diagnóstico")+
  xlab("# de pacientes")+
  theme(panel.grid.major.y = element_blank(),
        legend.title=element_blank(),
        legend.position=c(0.4,0.3),
        legend.text = element_text(size=7.5))+
  scale_colour_viridis(discrete=TRUE)
  

#División por sexo
capasits_oaxaca_reciente_figura_s <- capasits_oaxaca_2018_2021 %>% 
  mutate(ano_ingreso= factor(year(paciente_ingreso)),
         paciente_sexo= case_when(paciente_sexo=="F"~"Mujer cis",
                                  paciente_sexo=="M"~"Hombre cis",
                                  paciente_sexo=="TF"~"Mujer trans",
                                  paciente_sexo=="TM"~"Hombre trans")) %>% 
  group_by(ano_ingreso, paciente_sexo, paciente_sai) %>% 
  count()

capasits_oaxaca_reciente_figura_s <- ggplot(capasits_oaxaca_reciente_figura_s, aes(x= as.integer(n), y=ano_ingreso, colour=paciente_sexo))+
  geom_segment(aes(yend = ano_ingreso), xend = 0, colour = "grey50")+
  geom_point( size = 3)+
  ggtitle("")+
  theme_bw()+
  ylab("")+
  xlab("# de pacientes")+
  theme(panel.grid.major.y = element_blank(),
          legend.title=element_blank(),
        legend.position=c(0.7,0.2))+
scale_colour_viridis(discrete=TRUE)+
  facet_wrap(~paciente_sai, nrow=2)
  
figura_2 <- capasits_oaxaca_reciente_figura+capasits_oaxaca_reciente_figura_s+plot_annotation(tag_levels='A')


#ggsave(plot = figura_2, width = 6.1, height = 6.5, dpi = 300, filename = "figura_2.png")
```


![Figura 2](figura_2.png)



```{r bases adicionales de 2018-2021 cd4 y carga viral, include = F, warning=F}
cd4_oaxaca_2018_2021 <- read_excel("cd4_oaxaca.xlsx") %>% 
  filter(id_paciente%in%capasits_oaxaca_2018_2021$id_paciente)

cd4_oaxaca_2018_2019 <- read_excel("cd4_oaxaca.xlsx") %>% 
  filter(id_paciente%in%capasits_oaxaca_2018_2019$id_paciente)

cd4_oaxaca_2020_2021 <- read_excel("cd4_oaxaca.xlsx") %>% 
  filter(id_paciente%in%capasits_oaxaca_2020_2021$id_paciente)
####################
cv_oaxaca_2018_2021 <- read_excel("carga_viral_oaxaca.xlsx") %>% 
  filter(id_paciente%in%capasits_oaxaca_2018_2021$id_paciente)

cv_oaxaca_2018_2019 <- read_excel("carga_viral_oaxaca.xlsx") %>% 
  filter(id_paciente%in%capasits_oaxaca_2018_2019$id_paciente)

cv_oaxaca_2020_2021 <- read_excel("carga_viral_oaxaca.xlsx") %>% 
  filter(id_paciente%in%capasits_oaxaca_2020_2021$id_paciente)

```

Se recibieron además dos bases adicionales, las cuales incluyen información sobre todas las mediciones de linfocitos T CD4 y carga viral de VIH realizadas en pacientes de CAPASITS Oaxaca. En la base de linfocitos T CD4 (llamada *cd4_oaxaca_2018_2021*) hay información sobre `r n_distinct(cd4_oaxaca_2018_2021$id_paciente)` pacientes, mientras que en la de carga viral de VIH (llamada *cv_oaxaca_2018_2021*) hay información sobre `r n_distinct(cv_oaxaca_2018_2021$id_paciente)` pacientes. De los pacientes presentes en *capasits_oaxaca_2018_2021*, `r n_distinct(filter(cd4_oaxaca_2018_2021, id_paciente%in%capasits_oaxaca_2018_2021$id_paciente)$id_paciente)` (`r round(n_distinct(filter(cd4_oaxaca_2018_2021, id_paciente%in%capasits_oaxaca_2018_2021$id_paciente)$id_paciente)/n_distinct(capasits_oaxaca_2018_2021$id_paciente), 1)`%) tuvieron información sobre linfocitos T CD4 en la base *cd4_oaxaca_2018_2021*. Asimismo,  `r n_distinct(filter(cv_oaxaca_2018_2021, id_paciente%in%capasits_oaxaca_2018_2021$id_paciente)$id_paciente)` (`r round(n_distinct(filter(cv_oaxaca_2018_2021, id_paciente%in%capasits_oaxaca_2018_2021$id_paciente)$id_paciente)/n_distinct(capasits_oaxaca_2018_2021$id_paciente), 1)`%) tuvieron información sobre carga viral de VIH en *cv_oaxaca_2018_2021*. Todos los pacienes con información sobre carga viral también tuvieron información sobre linfocitos T CD4, de manera que hubo `r n_distinct(filter(cd4_oaxaca_2018_2021, id_paciente%in%capasits_oaxaca_2018_2021$id_paciente)$id_paciente)-n_distinct(filter(cv_oaxaca_2018_2021, id_paciente%in%capasits_oaxaca_2018_2021$id_paciente)$id_paciente)` más pacientes con información sobre linfocitos T CD4. En la **Tabla 2** se describen a detalle las características generales de los pacientes incluidos en la base *capasits_oaxaca_2018_2021*

```{r tabla 2, run = F, include = F, warning=F}
#Construiremos las variables que compondrán la tabla por separado para que sea más manejable

capasits_oaxaca_t2 <- capasits_oaxaca_2018_2021 %>% 
  mutate(ano_diagnostico=year(paciente_notificacion),
         ano_ingreso=year(paciente_ingreso))


#Género de los pacientes
year_t <- c("2018", "2019", "2020", "2021", "Todos")

#Tipo de pacientes (todos son en trataimento ARV)
paciente_tipo_t2 <- c(str_c(sum(capasits_oaxaca_t2$ano_ingreso=="2018"), " (", round(sum(capasits_oaxaca_t2$ano_ingreso=="2018")/nrow(capasits_oaxaca_t2), 3)*100, "%)"),
                                      str_c(sum(capasits_oaxaca_t2$ano_ingreso=="2019"), " (", round(sum(capasits_oaxaca_t2$ano_ingreso=="2019")/nrow(capasits_oaxaca_t2), 3)*100, "%)"),
                                      str_c(sum(capasits_oaxaca_t2$ano_ingreso=="2020"), " (", round(sum(capasits_oaxaca_t2$ano_ingreso=="2020")/nrow(capasits_oaxaca_t2), 3)*100, "%)"),
                                      str_c(sum(capasits_oaxaca_t2$ano_ingreso=="2021"), " (", round(sum(capasits_oaxaca_t2$ano_ingreso=="2021")/nrow(capasits_oaxaca_t2), 3)*100, "%)"),
                                      str_c(nrow(capasits_oaxaca_t2), " (100%)"))




#Sexo de los pacientes
paciente_sexo_fem_t2 <- c(str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_sexo=="F"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_sexo=="F")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2018")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_sexo=="F"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_sexo=="F")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2019")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_sexo=="F"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_sexo=="F")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2020")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t2,ano_ingreso=="2021")$paciente_sexo=="F"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2021")$paciente_sexo=="F")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2021")), 3)*100, "%)"),
                           str_c(sum(capasits_oaxaca_t2$paciente_sexo=="F"), " (100%)"))


paciente_sexo_masc_t2 <- c(str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_sexo=="M"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_sexo=="M")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2018")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_sexo=="M"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_sexo=="M")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2019")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_sexo=="M"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_sexo=="M")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2020")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t2,ano_ingreso=="2021")$paciente_sexo=="M"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2021")$paciente_sexo=="M")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2021")), 3)*100, "%)"),
                           str_c(sum(capasits_oaxaca_t2$paciente_sexo=="M"), " (100%)"))


paciente_sexo_mujtrans_t2 <- c(str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_sexo=="TF"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_sexo=="TF")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2018")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_sexo=="TF"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_sexo=="TF")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2019")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_sexo=="TF"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_sexo=="TF")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2020")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t2,ano_ingreso=="2021")$paciente_sexo=="TF"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2021")$paciente_sexo=="TF")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2021")), 3)*100, "%)"),
                           str_c(sum(capasits_oaxaca_t2$paciente_sexo=="TF"), " (100%)"))



#Edad de los pacientes (mediana y rango IQR)
paciente_edad_t2 <- c(str_c(median(filter(capasits_oaxaca_t2, ano_ingreso=="2018"&!is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca_t2, ano_ingreso=="2018"&!is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca_t2, ano_ingreso=="2018"&!is.na(paciente_edad))$paciente_edad)[4], ")"),
                     
                     str_c(median(filter(capasits_oaxaca_t2, ano_ingreso=="2019"&!is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca_t2, ano_ingreso=="2019"&!is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca_t2, ano_ingreso=="2019"&!is.na(paciente_edad))$paciente_edad)[4], ")"),
                     
                     str_c(median(filter(capasits_oaxaca_t2, ano_ingreso=="2020"&!is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca_t2, ano_ingreso=="2020"&!is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca_t2, ano_ingreso=="2020"&!is.na(paciente_edad))$paciente_edad)[4], ")"),
                     
                     str_c(median(filter(capasits_oaxaca_t2, ano_ingreso=="2021"&!is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca_t2, ano_ingreso=="2021"&!is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca_t2, ano_ingreso=="2021"&!is.na(paciente_edad))$paciente_edad)[4], ")"),
                     
                     str_c(median(filter(capasits_oaxaca_t2, !is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca_t2, !is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca_t2, !is.na(paciente_edad))$paciente_edad)[4], ")"))


#Si la paciente estaba o no embarazada
paciente_embarazada_t2 <- c(str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_vih_embarazada=="SI"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_vih_embarazada=="SI")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2018"&paciente_sexo=="F")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_vih_embarazada=="SI"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_vih_embarazada=="SI")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2019"&paciente_sexo=="F")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_vih_embarazada=="SI"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_vih_embarazada=="SI")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2020"&paciente_sexo=="F")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2,ano_ingreso=="2021")$paciente_vih_embarazada=="SI"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2021")$paciente_vih_embarazada=="SI")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2021"&paciente_sexo=="F")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t2$paciente_vih_embarazada=="SI"), " (", 
                                 round(sum(capasits_oaxaca_t2$paciente_vih_embarazada=="SI")/
                                         sum(capasits_oaxaca_t2$paciente_sexo=="F"), 3)*100, "%)"))

#Si la paciente estaba privada de su libertad

paciente_privada_t2 <- c(str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_priv_libertad=="S"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_priv_libertad=="S")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2018")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_priv_libertad=="S"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_priv_libertad=="S")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2019")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_priv_libertad=="S"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_priv_libertad=="S")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2020")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2,ano_ingreso=="2021")$paciente_priv_libertad=="S"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2021")$paciente_priv_libertad=="S")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2021")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t2$paciente_priv_libertad=="S"), " (", 
                                 round(sum(capasits_oaxaca_t2$paciente_priv_libertad=="S")/
                                         nrow(capasits_oaxaca_t2), 3)*100, "%)"))


#Si los pacientes tenían estatus de activo, desglosado por género
paciente_estatus_activo_t2 <- c(str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_estatus=="ACTIVO"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_estatus=="ACTIVO")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2018")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_estatus=="ACTIVO"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_estatus=="ACTIVO")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2019")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_estatus=="ACTIVO"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_estatus=="ACTIVO")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2020")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2,ano_ingreso=="2021")$paciente_estatus=="ACTIVO"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2021")$paciente_estatus=="ACTIVO")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2021")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t2$paciente_estatus=="ACTIVO"), " (", 
                                 round(sum(capasits_oaxaca_t2$paciente_estatus=="ACTIVO")/
                                         nrow(capasits_oaxaca_t2), 3)*100, "%)"))
  
  
  
 

#Si los pacientes tenían estatus de baja, desglosado por género
paciente_estatus_baja_t2 <- c(str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_estatus=="BAJA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_estatus=="BAJA")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2018")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_estatus=="BAJA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_estatus=="BAJA")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2019")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_estatus=="BAJA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_estatus=="BAJA")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2020")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2,ano_ingreso=="2021")$paciente_estatus=="BAJA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2021")$paciente_estatus=="BAJA")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2021")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t2$paciente_estatus=="BAJA"), " (", 
                                 round(sum(capasits_oaxaca_t2$paciente_estatus=="BAJA")/
                                         nrow(capasits_oaxaca_t2), 3)*100, "%)"))


#Si los pacientes tenían estatus de derivación, desglosado por género

paciente_estatus_derivacion_t2 <- c(str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2018")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2019")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2020")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2,ano_ingreso=="2021")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2021")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2021")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t2$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (", 
                                 round(sum(capasits_oaxaca_t2$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")/
                                         nrow(capasits_oaxaca_t2), 3)*100, "%)"))
  
  
  

#Si los pacientes tenían estatus de suspensión, desglosado por género
paciente_estatus_suspension_t2 <- c(str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_estatus=="EN SUSPENSION"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_estatus=="EN SUSPENSION")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2018")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_estatus=="EN SUSPENSION"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_estatus=="EN SUSPENSION")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2019")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_estatus=="EN SUSPENSION"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_estatus=="EN SUSPENSION")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2020")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2,ano_ingreso=="2021")$paciente_estatus=="EN SUSPENSION"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2021")$paciente_estatus=="EN SUSPENSION")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2021")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t2$paciente_estatus=="EN SUSPENSION"), " (", 
                                 round(sum(capasits_oaxaca_t2$paciente_estatus=="EN SUSPENSION")/
                                         nrow(capasits_oaxaca_t2), 3)*100, "%)"))
  
  


#Tratamiento para incluir en la tabla
 tratamiento_t2 <- group_by(capasits_oaxaca_t2, ano_ingreso, esquema) %>% 
   count() %>% 
   arrange(desc(n)) %>% 
   ungroup() %>% 
   group_by(ano_ingreso) %>% 
   slice(1)

tratamiento_whole_t2 <- group_by(capasits_oaxaca_t2, esquema) %>% 
  count() %>% 
  arrange(desc(n)) 


tratamiento_tab2 <- c(str_c(tratamiento_t2$esquema, " ", tratamiento_t2$n), str_c(tratamiento_whole_t2$esquema[1], " ", tratamiento_whole_t2$n[1]))

#Centro en donde reciben la atención
centro_oaxaca_t2 <- c(str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_sai=="CAPASITS - Oaxaca"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_sai=="CAPASITS - Oaxaca")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2018")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_sai=="CAPASITS - Oaxaca"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_sai=="CAPASITS - Oaxaca")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2019")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_sai=="CAPASITS - Oaxaca"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_sai=="CAPASITS - Oaxaca")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2020")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2,ano_ingreso=="2021")$paciente_sai=="CAPASITS - Oaxaca"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2021")$paciente_sai=="CAPASITS - Oaxaca")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2021")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t2$paciente_sai=="CAPASITS - Oaxaca"), " (", 
                                 round(sum(capasits_oaxaca_t2$paciente_sai=="CAPASITS - Oaxaca")/
                                         nrow(capasits_oaxaca_t2), 3)*100, "%)"))
  



centro_salina_t2 <- c(str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_sai=="CAPASITS - Salina Cruz"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_sai=="CAPASITS - Salina Cruz")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2018")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_sai=="CAPASITS - Salina Cruz"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_sai=="CAPASITS - Salina Cruz")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2019")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_sai=="CAPASITS - Salina Cruz"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_sai=="CAPASITS - Salina Cruz")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2020")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2,ano_ingreso=="2021")$paciente_sai=="CAPASITS - Salina Cruz"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2021")$paciente_sai=="CAPASITS - Salina Cruz")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2021")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t2$paciente_sai=="CAPASITS - Salina Cruz"), " (", 
                                 round(sum(capasits_oaxaca_t2$paciente_sai=="CAPASITS - Salina Cruz")/
                                         nrow(capasits_oaxaca_t2), 3)*100, "%)"))




#CD4 al inicio
cd4_oaxaca_base_primera_toma <- mutate(cd4_oaxaca_2018_2021, 
                             fecha_toma = ymd(fecha_toma)) %>% 
  group_by(id_paciente) %>% 
  arrange(fecha_toma) %>% 
  slice_head() %>% 
  mutate(tipo_toma = "primera")

cd4_oaxaca_base_ultima_toma <- mutate(cd4_oaxaca_2018_2021, 
                             fecha_toma = ymd(fecha_toma)) %>% 
  group_by(id_paciente) %>% 
  arrange(fecha_toma) %>% 
  slice_tail()%>% 
  mutate(tipo_toma = "ultima")

cd4_oaxaca_base_toma_al_ingreso <- mutate(cd4_oaxaca_2018_2021, 
                             fecha_toma = ymd(fecha_toma)) %>% 
  group_by(id_paciente) %>% 
  mutate(tipo_toma = "ingreso") %>% 
  left_join(select(capasits_oaxaca_t2, id_paciente,  paciente_ingreso) %>% mutate(id_paciente=as.double(id_paciente)), by= "id_paciente") %>% 
  mutate(fecha_cd4_fecha_ingreso=ifelse(fecha_toma-paciente_ingreso>=0, fecha_toma-paciente_ingreso,
                                        -(fecha_toma-paciente_ingreso))) %>% 
  slice_min(fecha_cd4_fecha_ingreso)


#Base con CD4 para oaxaca
cd4_oaxaca_t2 <- rbind(cd4_oaxaca_base_primera_toma, cd4_oaxaca_base_ultima_toma, select(cd4_oaxaca_base_toma_al_ingreso, -paciente_ingreso,
                                                                                           -fecha_cd4_fecha_ingreso)) %>% 
  left_join(select(capasits_oaxaca_t2, id_paciente,  paciente_ingreso) %>% mutate(id_paciente=as.double(id_paciente)), by= "id_paciente") %>% 
  mutate(ano_ingreso=year(paciente_ingreso))



cd4_tiempo <- function(x){
  c(str_c(median(filter(cd4_oaxaca_t2, ano_ingreso=="2018"&!is.na(resultado)&tipo_toma==x)$resultado), " (", 
                         fivenum(filter(cd4_oaxaca_t2, ano_ingreso=="2018"&!is.na(resultado)&tipo_toma==x)$resultado)[2],
                           "-", fivenum(filter(cd4_oaxaca_t2, ano_ingreso=="2018"&!is.na(resultado)&tipo_toma==x)$resultado)[4], ")"),
                     
                     str_c(median(filter(cd4_oaxaca_t2, ano_ingreso=="2019"&!is.na(resultado)&tipo_toma==x)$resultado), " (", fivenum(filter(cd4_oaxaca_t2, ano_ingreso=="2019"&!is.na(resultado)&tipo_toma==x)$resultado)[2],
                           "-", fivenum(filter(cd4_oaxaca_t2, ano_ingreso=="2019"&!is.na(resultado)&tipo_toma==x)$resultado)[4], ")"),
                     
                     str_c(median(filter(cd4_oaxaca_t2, ano_ingreso=="2020"&!is.na(resultado)&tipo_toma==x)$resultado), " (", fivenum(filter(cd4_oaxaca_t2, ano_ingreso=="2020"&!is.na(resultado)&tipo_toma==x)$resultado)[2],
                           "-", fivenum(filter(cd4_oaxaca_t2, ano_ingreso=="2020"&!is.na(resultado)&tipo_toma==x)$resultado)[4], ")"),
                     
                     str_c(median(filter(cd4_oaxaca_t2, ano_ingreso=="2021"&!is.na(resultado)&tipo_toma==x)$resultado), " (", fivenum(filter(cd4_oaxaca_t2, ano_ingreso=="2021"&!is.na(resultado)&tipo_toma==x)$resultado)[2],
                           "-", fivenum(filter(cd4_oaxaca_t2, ano_ingreso=="2021"&!is.na(resultado)&tipo_toma==x)$resultado)[4], ")"),
                     
                     str_c(median(filter(cd4_oaxaca_t2, !is.na(resultado)&tipo_toma==x)$resultado), " (", fivenum(filter(cd4_oaxaca_t2, !is.na(resultado)&tipo_toma==x)$resultado)[2],
                           "-", fivenum(filter(cd4_oaxaca_t2, !is.na(resultado)&tipo_toma==x)$resultado)[4], ")"))
}


cd4_inicio_t2 <- cd4_tiempo("primera")

#Los primeros CD4 que se tomaron
cd4_inicio_t2 <- cd4_tiempo("primera")


#CD4 más recientes tomados
cd4_ultima_t2 <- cd4_tiempo("ultima")

#CD4 al ingreso
cd4_ingreso_t2 <- cd4_tiempo("ingreso")



###CARGA VIRAL
#CD4 al inicio
cv_oaxaca_base_primera_toma <- mutate(cv_oaxaca_2018_2021, 
                             fecha_toma = ymd(fecha_toma)) %>% 
  group_by(id_paciente) %>% 
  arrange(fecha_toma) %>% 
  slice_head() %>% 
  mutate(tipo_toma = "primera")

cv_oaxaca_base_ultima_toma <- mutate(cv_oaxaca_2018_2021, 
                             fecha_toma = ymd(fecha_toma)) %>% 
  group_by(id_paciente) %>% 
  arrange(fecha_toma) %>% 
  slice_tail()%>% 
  mutate(tipo_toma = "ultima")

cv_oaxaca_base_toma_al_ingreso <- mutate(cv_oaxaca_2018_2021, 
                             fecha_toma = ymd(fecha_toma)) %>% 
  group_by(id_paciente) %>% 
  mutate(tipo_toma = "ingreso") %>% 
  left_join(select(capasits_oaxaca_t2, id_paciente,  paciente_ingreso) %>% mutate(id_paciente=as.double(id_paciente)), by= "id_paciente") %>% 
  mutate(fecha_cv_fecha_ingreso=ifelse(fecha_toma-paciente_ingreso>=0, fecha_toma-paciente_ingreso,
                                        -(fecha_toma-paciente_ingreso))) %>% 
  slice_min(fecha_cv_fecha_ingreso)


#Base con CD4 para oaxaca
cv_oaxaca_t2 <- rbind(cv_oaxaca_base_primera_toma, cv_oaxaca_base_ultima_toma, select(cv_oaxaca_base_toma_al_ingreso, -paciente_ingreso,
                                                                                           -fecha_cv_fecha_ingreso)) %>% 
  left_join(select(capasits_oaxaca_t2, id_paciente,  paciente_ingreso) %>% mutate(id_paciente=as.double(id_paciente)), by= "id_paciente") %>% 
  mutate(ano_ingreso=year(paciente_ingreso),
         indetectable_50=ifelse(resultado<=50, T, F),
         indetectable_200=ifelse(resultado<=200, T, F))



cv_tiempo <- function(x){
  c(str_c(median(filter(cv_oaxaca_t2, ano_ingreso=="2018"&!is.na(resultado)&tipo_toma==x)$resultado), " (", 
                         fivenum(filter(cv_oaxaca_t2, ano_ingreso=="2018"&!is.na(resultado)&tipo_toma==x)$resultado)[2],
                           "-", fivenum(filter(cv_oaxaca_t2, ano_ingreso=="2018"&!is.na(resultado)&tipo_toma==x)$resultado)[4], ")"),
                     
                     str_c(median(filter(cv_oaxaca_t2, ano_ingreso=="2019"&!is.na(resultado)&tipo_toma==x)$resultado), " (", fivenum(filter(cv_oaxaca_t2, ano_ingreso=="2019"&!is.na(resultado)&tipo_toma==x)$resultado)[2],
                           "-", fivenum(filter(cv_oaxaca_t2, ano_ingreso=="2019"&!is.na(resultado)&tipo_toma==x)$resultado)[4], ")"),
                     
                     str_c(median(filter(cv_oaxaca_t2, ano_ingreso=="2020"&!is.na(resultado)&tipo_toma==x)$resultado), " (", fivenum(filter(cv_oaxaca_t2, ano_ingreso=="2020"&!is.na(resultado)&tipo_toma==x)$resultado)[2],
                           "-", fivenum(filter(cv_oaxaca_t2, ano_ingreso=="2020"&!is.na(resultado)&tipo_toma==x)$resultado)[4], ")"),
                     
                     str_c(median(filter(cv_oaxaca_t2, ano_ingreso=="2021"&!is.na(resultado)&tipo_toma==x)$resultado), " (", fivenum(filter(cv_oaxaca_t2, ano_ingreso=="2021"&!is.na(resultado)&tipo_toma==x)$resultado)[2],
                           "-", fivenum(filter(cv_oaxaca_t2, ano_ingreso=="2021"&!is.na(resultado)&tipo_toma==x)$resultado)[4], ")"),
                     
                     str_c(median(filter(cv_oaxaca_t2, !is.na(resultado)&tipo_toma==x)$resultado), " (", fivenum(filter(cv_oaxaca_t2, !is.na(resultado)&tipo_toma==x)$resultado)[2],
                           "-", fivenum(filter(cv_oaxaca_t2, !is.na(resultado)&tipo_toma==x)$resultado)[4], ")"))
}



#Los primeros CD4 que se tomaron
cv_inicio_t2 <- cv_tiempo("primera")

#CD4 más recientes tomados
cv_ultima_t2 <- cv_tiempo("ultima")

#CD4 al ingreso
cv_ingreso_t2 <- cv_tiempo("ingreso")


##########Carga viral indetectable
cv_indetectable <- function(x, y){
  if(y==50){
  c(str_c(sum(filter(cv_oaxaca_t2, ano_ingreso=="2018"&tipo_toma==x)$indetectable_50==T), " (", 
                                 round(sum(filter(cv_oaxaca_t2, ano_ingreso=="2018"&tipo_toma==x)$indetectable_50==T)/
                                         nrow(filter(cv_oaxaca_t2, ano_ingreso=="2018"&tipo_toma==x)), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(cv_oaxaca_t2, ano_ingreso=="2019"&tipo_toma==x)$indetectable_50==T), " (", 
                                 round(sum(filter(cv_oaxaca_t2, ano_ingreso=="2019"&tipo_toma==x)$indetectable_50==T)/
                                         nrow(filter(cv_oaxaca_t2, ano_ingreso=="2019"&tipo_toma==x)), 3)*100, "%)"),
                           #
                           str_c(sum(filter(cv_oaxaca_t2, ano_ingreso=="2020"&tipo_toma==x)$indetectable_50==T), " (", 
                                 round(sum(filter(cv_oaxaca_t2, ano_ingreso=="2020"&tipo_toma==x)$indetectable_50==T)/
                                         nrow(filter(cv_oaxaca_t2, ano_ingreso=="2020"&tipo_toma==x)), 3)*100, "%)"),
                           #
                           str_c(sum(filter(cv_oaxaca_t2,ano_ingreso=="2021"&tipo_toma==x)$indetectable_50==T), " (", 
                                 round(sum(filter(cv_oaxaca_t2, ano_ingreso=="2021"&tipo_toma==x)$indetectable_50==T)/
                                         nrow(filter(cv_oaxaca_t2, ano_ingreso=="2021"&tipo_toma==x)), 3)*100, "%)"),
                           #
                           str_c(sum(cv_oaxaca_t2$indetectable_50==T), " (", 
                                 round(sum(cv_oaxaca_t2$indetectable_50==T)/
                                         nrow(cv_oaxaca_t2), 3)*100, "%)"))
  }else{
      c(str_c(sum(filter(cv_oaxaca_t2, ano_ingreso=="2018"&tipo_toma==x)$indetectable_200==T), " (", 
                                 round(sum(filter(cv_oaxaca_t2, ano_ingreso=="2018"&tipo_toma==x)$indetectable_200==T)/
                                         nrow(filter(cv_oaxaca_t2, ano_ingreso=="2018"&tipo_toma==x)), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(cv_oaxaca_t2, ano_ingreso=="2019"&tipo_toma==x)$indetectable_200==T), " (", 
                                 round(sum(filter(cv_oaxaca_t2, ano_ingreso=="2019"&tipo_toma==x)$indetectable_200==T)/
                                         nrow(filter(cv_oaxaca_t2, ano_ingreso=="2019"&tipo_toma==x)), 3)*100, "%)"),
                           #
                           str_c(sum(filter(cv_oaxaca_t2, ano_ingreso=="2020"&tipo_toma==x)$indetectable_200==T), " (", 
                                 round(sum(filter(cv_oaxaca_t2, ano_ingreso=="2020"&tipo_toma==x)$indetectable_200==T)/
                                         nrow(filter(cv_oaxaca_t2, ano_ingreso=="2020"&tipo_toma==x)), 3)*100, "%)"),
                           #
                           str_c(sum(filter(cv_oaxaca_t2,ano_ingreso=="2021"&tipo_toma==x)$indetectable_200==T), " (", 
                                 round(sum(filter(cv_oaxaca_t2, ano_ingreso=="2021"&tipo_toma==x)$indetectable_200==T)/
                                         nrow(filter(cv_oaxaca_t2, ano_ingreso=="2021"&tipo_toma==x)), 3)*100, "%)"),
                           #
                           str_c(sum(cv_oaxaca_t2$indetectable_200==T), " (", 
                                 round(sum(cv_oaxaca_t2$indetectable_200==T)/
                                         nrow(cv_oaxaca_t2), 3)*100, "%)"))
  }
}
#Carga viral más reciente (sólo si al menos 6 meses de seguimiento)
cv_indetectable_inicial_50_t2 <- cv_indetectable(x="primera", y=50)
cv_indetectable_inicial_200_t2 <- cv_indetectable(x="primera", y=200)

#Carga viral más reciente (sólo si al menos 6 meses de seguimiento)
cv_indetectable_ultima_50_t2 <- cv_indetectable(x="ultima", y=50)
cv_indetectable_ultima_200_t2 <- cv_indetectable(x="ultima", y=200)

#Carga viral más reciente (sólo si al menos 6 meses de seguimiento)
cv_indetectable_ingreso_50_t2 <- cv_indetectable(x="ingreso", y=50)
cv_indetectable_ingreso_200_t2 <- cv_indetectable(x="ingreso", y=200)



####TABLA 2 
table_2 <- data.frame(ano_ingreso=year_t,
                      #####################
                      paciente_tipo=paciente_tipo_t2,
                      #####################
                      paciente_sexo=rep("-", times=5),
                      #####################
                      paciente_sexo_mujer=paciente_sexo_fem_t2,
                      #####################
                      paciente_sexo_masc=paciente_sexo_masc_t2,
                      #####################
                      paciente_sexo_mujtrans=paciente_sexo_mujtrans_t2,
                      #####################
                      paciente_edad=paciente_edad_t2,
                      #####################
                      paciente_embarazada=paciente_embarazada_t2,
                      #####################
                      paciente_privada_libertad=paciente_privada_t2,
                      #####################
                      paciente_estatus=rep("-", times=5),
                      #####################
                      paciente_estatus_activo=paciente_estatus_activo_t2,
                      #####################
                      paciente_estatus_baja=paciente_estatus_baja_t2,
                      #####################
                      paciente_estatus_en_derivacion=paciente_estatus_derivacion_t2,
                      #####################
                      paciente_estatus_suspension=paciente_estatus_suspension_t2,
                      #####################
                      paciente_tratamiento= tratamiento_tab2,
                      #####################
                      paciente_centro=rep("-", times=5),
                      #####################
                      paciente_centro_oaxaca= centro_oaxaca_t2,
                      #####################
                      paciente_centro_salina=centro_salina_t2,
                      #####################
                      conteo_cd4=rep("-", times=5),
                    #####################
                      cd4_inicio=cd4_inicio_t2,
                    #####################
                    cd4_ingreso=cd4_ingreso_t2,
                    #####################
                    cd4_ultimos=cd4_ultima_t2,
                    #####################
                      carga_viral=rep("-", times=5),
                    #####################
                      cv_inicio=cv_inicio_t2,
                    #####################
                    cv_ingreso=cv_ingreso_t2,
                    #####################
                    cv_ultimos=cv_ultima_t2,
                    #####################
                      cv_inicio_indetect_50=cv_indetectable_inicial_50_t2,
                      cv_inicio_indetect_200=cv_indetectable_inicial_200_t2,
                    #####################
                    cv_ingreso_indetect_50=cv_indetectable_ingreso_50_t2,
                      cv_ingreso_indetect_200=cv_indetectable_ingreso_200_t2,
                    #####################
                    cv_ultima_indetect_50=cv_indetectable_ultima_50_t2,
                      cv_ultima_indetect_200=cv_indetectable_ultima_200_t2
                      )


View(table_2)


```

```{r tabla 3, run = F, include = F, warning=F}
#Construiremos las variables que compondrán la tabla por separado para que sea más manejable


capasits_oaxaca_t3 <- filter(capasits_oaxaca_t2, ano_diagnostico == c("2018", "2019", "2020", "2021"))


#Tipo de pacientes (todos son en trataimento ARV)
paciente_tipo_t3 <- c(str_c(sum(capasits_oaxaca_t3$ano_diagnostico=="2018", na.rm = T), " (", round(sum(capasits_oaxaca_t3$ano_diagnostico=="2018", na.rm = T)/nrow(capasits_oaxaca_t3), 3)*100, "%)"),
                                      str_c(sum(capasits_oaxaca_t3$ano_diagnostico=="2019", na.rm = T), " (", round(sum(capasits_oaxaca_t3$ano_diagnostico=="2019", na.rm = T)/nrow(capasits_oaxaca_t3), 3)*100, "%)"),
                                      str_c(sum(capasits_oaxaca_t3$ano_diagnostico=="2020", na.rm = T), " (", round(sum(capasits_oaxaca_t3$ano_diagnostico=="2020", na.rm = T)/nrow(capasits_oaxaca_t3), 3)*100, "%)"),
                                      str_c(sum(capasits_oaxaca_t3$ano_diagnostico=="2021", na.rm = T), " (", round(sum(capasits_oaxaca_t3$ano_diagnostico=="2021", na.rm = T)/nrow(capasits_oaxaca_t3), 3)*100, "%)"),
                                      str_c(nrow(capasits_oaxaca_t3), " (100%)"))




#Sexo de los pacientes
paciente_sexo_fem_t3 <- c(str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")$paciente_sexo=="F"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")$paciente_sexo=="F")/nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")$paciente_sexo=="F"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")$paciente_sexo=="F")/nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")$paciente_sexo=="F"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")$paciente_sexo=="F")/nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t3,ano_diagnostico=="2021")$paciente_sexo=="F"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2021")$paciente_sexo=="F")/nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2021")), 3)*100, "%)"),
                           str_c(sum(capasits_oaxaca_t3$paciente_sexo=="F"), " (100%)"))


paciente_sexo_masc_t3 <- c(str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")$paciente_sexo=="M"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")$paciente_sexo=="M")/nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")$paciente_sexo=="M"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")$paciente_sexo=="M")/nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")$paciente_sexo=="M"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")$paciente_sexo=="M")/nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t3,ano_diagnostico=="2021")$paciente_sexo=="M"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2021")$paciente_sexo=="M")/nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2021")), 3)*100, "%)"),
                           str_c(sum(capasits_oaxaca_t3$paciente_sexo=="M"), " (100%)"))


paciente_sexo_mujtrans_t3 <- c(str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")$paciente_sexo=="TF"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")$paciente_sexo=="TF")/nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")$paciente_sexo=="TF"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")$paciente_sexo=="TF")/nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")$paciente_sexo=="TF"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")$paciente_sexo=="TF")/nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t3,ano_diagnostico=="2021")$paciente_sexo=="TF"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2021")$paciente_sexo=="TF")/nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2021")), 3)*100, "%)"),
                           str_c(sum(capasits_oaxaca_t3$paciente_sexo=="TF"), " (100%)"))



#Edad de los pacientes (mediana y rango IQR)
paciente_edad_t3 <- c(str_c(median(filter(capasits_oaxaca_t3, ano_diagnostico=="2018"&!is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018"&!is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018"&!is.na(paciente_edad))$paciente_edad)[4], ")"),
                     
                     str_c(median(filter(capasits_oaxaca_t3, ano_diagnostico=="2019"&!is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019"&!is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019"&!is.na(paciente_edad))$paciente_edad)[4], ")"),
                     
                     str_c(median(filter(capasits_oaxaca_t3, ano_diagnostico=="2020"&!is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020"&!is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020"&!is.na(paciente_edad))$paciente_edad)[4], ")"),
                     
                     str_c(median(filter(capasits_oaxaca_t3, ano_diagnostico=="2021"&!is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca_t3, ano_diagnostico=="2021"&!is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca_t3, ano_diagnostico=="2021"&!is.na(paciente_edad))$paciente_edad)[4], ")"),
                     
                     str_c(median(filter(capasits_oaxaca_t3, !is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca_t3, !is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca_t3, !is.na(paciente_edad))$paciente_edad)[4], ")"))


#Si la paciente estaba o no embarazada
paciente_embarazada_t3 <- c(str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")$paciente_vih_embarazada=="SI"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")$paciente_vih_embarazada=="SI")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2018"&paciente_sexo=="F")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")$paciente_vih_embarazada=="SI"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")$paciente_vih_embarazada=="SI")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2019"&paciente_sexo=="F")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")$paciente_vih_embarazada=="SI"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")$paciente_vih_embarazada=="SI")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2020"&paciente_sexo=="F")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t3,ano_diagnostico=="2021")$paciente_vih_embarazada=="SI"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2021")$paciente_vih_embarazada=="SI")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2021"&paciente_sexo=="F")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t3$paciente_vih_embarazada=="SI"), " (", 
                                 round(sum(capasits_oaxaca_t3$paciente_vih_embarazada=="SI")/
                                         sum(capasits_oaxaca_t3$paciente_sexo=="F"), 3)*100, "%)"))

#Si la paciente estaba privada de su libertad

paciente_privada_t3 <- c(str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")$paciente_priv_libertad=="S"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")$paciente_priv_libertad=="S")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")$paciente_priv_libertad=="S"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")$paciente_priv_libertad=="S")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")$paciente_priv_libertad=="S"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")$paciente_priv_libertad=="S")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t3,ano_diagnostico=="2021")$paciente_priv_libertad=="S"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2021")$paciente_priv_libertad=="S")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2021")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t3$paciente_priv_libertad=="S"), " (", 
                                 round(sum(capasits_oaxaca_t3$paciente_priv_libertad=="S")/
                                         nrow(capasits_oaxaca_t3), 3)*100, "%)"))


#Si los pacientes tenían estatus de activo, desglosado por género
paciente_estatus_activo_t3 <- c(str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")$paciente_estatus=="ACTIVO"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")$paciente_estatus=="ACTIVO")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")$paciente_estatus=="ACTIVO"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")$paciente_estatus=="ACTIVO")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")$paciente_estatus=="ACTIVO"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")$paciente_estatus=="ACTIVO")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t3,ano_diagnostico=="2021")$paciente_estatus=="ACTIVO"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2021")$paciente_estatus=="ACTIVO")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2021")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t3$paciente_estatus=="ACTIVO"), " (", 
                                 round(sum(capasits_oaxaca_t3$paciente_estatus=="ACTIVO")/
                                         nrow(capasits_oaxaca_t3), 3)*100, "%)"))
  
  
  
 

#Si los pacientes tenían estatus de baja, desglosado por género
paciente_estatus_baja_t3 <- c(str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")$paciente_estatus=="BAJA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")$paciente_estatus=="BAJA")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")$paciente_estatus=="BAJA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")$paciente_estatus=="BAJA")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")$paciente_estatus=="BAJA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")$paciente_estatus=="BAJA")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t3,ano_diagnostico=="2021")$paciente_estatus=="BAJA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2021")$paciente_estatus=="BAJA")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2021")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t3$paciente_estatus=="BAJA"), " (", 
                                 round(sum(capasits_oaxaca_t3$paciente_estatus=="BAJA")/
                                         nrow(capasits_oaxaca_t3), 3)*100, "%)"))


#Si los pacientes tenían estatus de derivación, desglosado por género

paciente_estatus_derivacion_t3 <- c(str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t3,ano_diagnostico=="2021")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2021")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2021")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t3$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (", 
                                 round(sum(capasits_oaxaca_t3$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")/
                                         nrow(capasits_oaxaca_t3), 3)*100, "%)"))
  
  
  

#Si los pacientes tenían estatus de suspensión, desglosado por género
paciente_estatus_suspension_t3 <- c(str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")$paciente_estatus=="EN SUSPENSION"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")$paciente_estatus=="EN SUSPENSION")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")$paciente_estatus=="EN SUSPENSION"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")$paciente_estatus=="EN SUSPENSION")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")$paciente_estatus=="EN SUSPENSION"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")$paciente_estatus=="EN SUSPENSION")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t3,ano_diagnostico=="2021")$paciente_estatus=="EN SUSPENSION"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2021")$paciente_estatus=="EN SUSPENSION")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2021")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t3$paciente_estatus=="EN SUSPENSION"), " (", 
                                 round(sum(capasits_oaxaca_t3$paciente_estatus=="EN SUSPENSION")/
                                         nrow(capasits_oaxaca_t3), 3)*100, "%)"))
  
  


#Tratamiento para incluir en la tabla
 tratamiento_t3 <- filter(capasits_oaxaca_t3, ano_diagnostico == c("2018", "2019", "2020", "2021")) %>% 
   group_by(ano_diagnostico, esquema) %>% 
   count() %>% 
   arrange(desc(n)) %>% 
   ungroup() %>% 
   group_by(ano_diagnostico) %>% 
   slice(1)

tratamiento_whole_t3 <- filter(capasits_oaxaca_t3, ano_diagnostico == c("2018", "2019", "2020", "2021")) %>% 
  group_by( esquema) %>% 
  count() %>% 
  arrange(desc(n)) 


tratamiento_tab3 <- c(str_c(tratamiento_t3$esquema, " ", tratamiento_t3$n), str_c(tratamiento_whole_t3$esquema[1], " ", tratamiento_whole_t3$n[1]))

#Centro en donde reciben la atención
centro_oaxaca_t3 <- c(str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")$paciente_sai=="CAPASITS - Oaxaca"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")$paciente_sai=="CAPASITS - Oaxaca")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")$paciente_sai=="CAPASITS - Oaxaca"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")$paciente_sai=="CAPASITS - Oaxaca")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")$paciente_sai=="CAPASITS - Oaxaca"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")$paciente_sai=="CAPASITS - Oaxaca")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t3,ano_diagnostico=="2021")$paciente_sai=="CAPASITS - Oaxaca"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2021")$paciente_sai=="CAPASITS - Oaxaca")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2021")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t3$paciente_sai=="CAPASITS - Oaxaca"), " (", 
                                 round(sum(capasits_oaxaca_t3$paciente_sai=="CAPASITS - Oaxaca")/
                                         nrow(capasits_oaxaca_t3), 3)*100, "%)"))
  



centro_salina_t3 <- c(str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")$paciente_sai=="CAPASITS - Salina Cruz"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")$paciente_sai=="CAPASITS - Salina Cruz")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2018")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")$paciente_sai=="CAPASITS - Salina Cruz"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")$paciente_sai=="CAPASITS - Salina Cruz")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2019")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")$paciente_sai=="CAPASITS - Salina Cruz"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")$paciente_sai=="CAPASITS - Salina Cruz")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2020")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t3,ano_diagnostico=="2021")$paciente_sai=="CAPASITS - Salina Cruz"), " (", 
                                 round(sum(filter(capasits_oaxaca_t3, ano_diagnostico=="2021")$paciente_sai=="CAPASITS - Salina Cruz")/
                                         nrow(filter(capasits_oaxaca_t3, ano_diagnostico=="2021")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t3$paciente_sai=="CAPASITS - Salina Cruz"), " (", 
                                 round(sum(capasits_oaxaca_t3$paciente_sai=="CAPASITS - Salina Cruz")/
                                         nrow(capasits_oaxaca_t3), 3)*100, "%)"))




cd4_oaxaca_t3 <- filter(cd4_oaxaca_2018_2021, id_paciente%in%capasits_oaxaca_t3$id_paciente)

#CD4 al inicio
cd4_oaxaca_base_primera_toma_t3 <- mutate(cd4_oaxaca_t3, 
                             fecha_toma = ymd(fecha_toma)) %>% 
  group_by(id_paciente) %>% 
  arrange(fecha_toma) %>% 
  slice_head() %>% 
  mutate(tipo_toma = "primera")

cd4_oaxaca_base_ultima_toma_t3 <- mutate(cd4_oaxaca_t3, 
                             fecha_toma = ymd(fecha_toma)) %>% 
  group_by(id_paciente) %>% 
  arrange(fecha_toma) %>% 
  slice_tail()%>% 
  mutate(tipo_toma = "ultima")

cd4_oaxaca_base_toma_al_ingreso_t3 <- mutate(cd4_oaxaca_t3, 
                             fecha_toma = ymd(fecha_toma)) %>% 
  group_by(id_paciente) %>% 
  mutate(tipo_toma = "ingreso") %>% 
  left_join(select(capasits_oaxaca_t3, id_paciente,  paciente_ingreso) %>% mutate(id_paciente=as.double(id_paciente)), by= "id_paciente") %>% 
  mutate(fecha_cd4_fecha_ingreso=ifelse(fecha_toma-paciente_ingreso>=0, fecha_toma-paciente_ingreso,
                                        -(fecha_toma-paciente_ingreso))) %>% 
  slice_min(fecha_cd4_fecha_ingreso)


#Base con CD4 para oaxaca
cd4_oaxaca_t3 <- rbind(cd4_oaxaca_base_primera_toma_t3, cd4_oaxaca_base_ultima_toma_t3, select(cd4_oaxaca_base_toma_al_ingreso_t3, -paciente_ingreso,
                                                                                           -fecha_cd4_fecha_ingreso)) %>% 
  left_join(select(capasits_oaxaca_t3, id_paciente,  paciente_ingreso) %>% mutate(id_paciente=as.double(id_paciente)), by= "id_paciente") %>% 
  mutate(ano_ingreso=year(paciente_ingreso))



cd4_tiempo_t3 <- function(x){
  c(str_c(median(filter(cd4_oaxaca_t3, ano_ingreso=="2018"&!is.na(resultado)&tipo_toma==x)$resultado), " (", 
                         fivenum(filter(cd4_oaxaca_t3, ano_ingreso=="2018"&!is.na(resultado)&tipo_toma==x)$resultado)[2],
                           "-", fivenum(filter(cd4_oaxaca_t3, ano_ingreso=="2018"&!is.na(resultado)&tipo_toma==x)$resultado)[4], ")"),
                     
                     str_c(median(filter(cd4_oaxaca_t3, ano_ingreso=="2019"&!is.na(resultado)&tipo_toma==x)$resultado), " (", fivenum(filter(cd4_oaxaca_t3, ano_ingreso=="2019"&!is.na(resultado)&tipo_toma==x)$resultado)[2],
                           "-", fivenum(filter(cd4_oaxaca_t3, ano_ingreso=="2019"&!is.na(resultado)&tipo_toma==x)$resultado)[4], ")"),
                     
                     str_c(median(filter(cd4_oaxaca_t3, ano_ingreso=="2020"&!is.na(resultado)&tipo_toma==x)$resultado), " (", fivenum(filter(cd4_oaxaca_t3, ano_ingreso=="2020"&!is.na(resultado)&tipo_toma==x)$resultado)[2],
                           "-", fivenum(filter(cd4_oaxaca_t3, ano_ingreso=="2020"&!is.na(resultado)&tipo_toma==x)$resultado)[4], ")"),
                     
                     str_c(median(filter(cd4_oaxaca_t3, ano_ingreso=="2021"&!is.na(resultado)&tipo_toma==x)$resultado), " (", fivenum(filter(cd4_oaxaca_t3, ano_ingreso=="2021"&!is.na(resultado)&tipo_toma==x)$resultado)[2],
                           "-", fivenum(filter(cd4_oaxaca_t3, ano_ingreso=="2021"&!is.na(resultado)&tipo_toma==x)$resultado)[4], ")"),
                     
                     str_c(median(filter(cd4_oaxaca_t3, !is.na(resultado)&tipo_toma==x)$resultado), " (", fivenum(filter(cd4_oaxaca_t3, !is.na(resultado)&tipo_toma==x)$resultado)[2],
                           "-", fivenum(filter(cd4_oaxaca_t3, !is.na(resultado)&tipo_toma==x)$resultado)[4], ")"))
}


#Los primeros CD4 que se tomaron
cd4_inicio_t3 <- cd4_tiempo_t3("primera")

#CD4 más recientes tomados
cd4_ultima_t3 <- cd4_tiempo_t3("ultima")

#CD4 al ingreso
cd4_ingreso_t3 <- cd4_tiempo_t3("ingreso")



###CARGA VIRAL
cv_oaxaca_t3 <- filter(cv_oaxaca_2018_2021, id_paciente%in%capasits_oaxaca_t3$id_paciente)


#Cv al inicio
cv_oaxaca_base_primera_toma_t3 <- mutate(cv_oaxaca_t3, 
                             fecha_toma = ymd(fecha_toma)) %>% 
  group_by(id_paciente) %>% 
  arrange(fecha_toma) %>% 
  slice_head() %>% 
  mutate(tipo_toma = "primera")

cv_oaxaca_base_ultima_toma_t3 <- mutate(cv_oaxaca_t3, 
                             fecha_toma = ymd(fecha_toma)) %>% 
  group_by(id_paciente) %>% 
  arrange(fecha_toma) %>% 
  slice_tail()%>% 
  mutate(tipo_toma = "ultima")

cv_oaxaca_base_toma_al_ingreso_t3 <- mutate(cv_oaxaca_t3, 
                             fecha_toma = ymd(fecha_toma)) %>% 
  group_by(id_paciente) %>% 
  mutate(tipo_toma = "ingreso") %>% 
  left_join(select(capasits_oaxaca_t3, id_paciente,  paciente_ingreso) %>% mutate(id_paciente=as.double(id_paciente)), by= "id_paciente") %>% 
  mutate(fecha_cv_fecha_ingreso=ifelse(fecha_toma-paciente_ingreso>=0, fecha_toma-paciente_ingreso,
                                        -(fecha_toma-paciente_ingreso))) %>% 
  slice_min(fecha_cv_fecha_ingreso)


#Base con cv para oaxaca
cv_oaxaca_t3 <- rbind(cv_oaxaca_base_primera_toma_t3, cv_oaxaca_base_ultima_toma_t3, select(cv_oaxaca_base_toma_al_ingreso_t3, -paciente_ingreso,
                                                                                           -fecha_cv_fecha_ingreso)) %>% 
  left_join(select(capasits_oaxaca_t3, id_paciente,  paciente_ingreso) %>% mutate(id_paciente=as.double(id_paciente)), by= "id_paciente") %>% 
  mutate(ano_ingreso=year(paciente_ingreso),
         indetectable_50=ifelse(resultado<=50, T, F),
         indetectable_200=ifelse(resultado<=200, T, F))



cv_tiempo_t3 <- function(x){
  c(str_c(median(filter(cv_oaxaca_t3, ano_ingreso=="2018"&!is.na(resultado)&tipo_toma==x)$resultado), " (", 
                         fivenum(filter(cv_oaxaca_t3, ano_ingreso=="2018"&!is.na(resultado)&tipo_toma==x)$resultado)[2],
                           "-", fivenum(filter(cv_oaxaca_t3, ano_ingreso=="2018"&!is.na(resultado)&tipo_toma==x)$resultado)[4], ")"),
                     
                     str_c(median(filter(cv_oaxaca_t3, ano_ingreso=="2019"&!is.na(resultado)&tipo_toma==x)$resultado), " (", fivenum(filter(cv_oaxaca_t3, ano_ingreso=="2019"&!is.na(resultado)&tipo_toma==x)$resultado)[2],
                           "-", fivenum(filter(cv_oaxaca_t3, ano_ingreso=="2019"&!is.na(resultado)&tipo_toma==x)$resultado)[4], ")"),
                     
                     str_c(median(filter(cv_oaxaca_t3, ano_ingreso=="2020"&!is.na(resultado)&tipo_toma==x)$resultado), " (", fivenum(filter(cv_oaxaca_t3, ano_ingreso=="2020"&!is.na(resultado)&tipo_toma==x)$resultado)[2],
                           "-", fivenum(filter(cv_oaxaca_t3, ano_ingreso=="2020"&!is.na(resultado)&tipo_toma==x)$resultado)[4], ")"),
                     
                     str_c(median(filter(cv_oaxaca_t3, ano_ingreso=="2021"&!is.na(resultado)&tipo_toma==x)$resultado), " (", fivenum(filter(cv_oaxaca_t3, ano_ingreso=="2021"&!is.na(resultado)&tipo_toma==x)$resultado)[2],
                           "-", fivenum(filter(cv_oaxaca_t3, ano_ingreso=="2021"&!is.na(resultado)&tipo_toma==x)$resultado)[4], ")"),
                     
                     str_c(median(filter(cv_oaxaca_t3, !is.na(resultado)&tipo_toma==x)$resultado), " (", fivenum(filter(cv_oaxaca_t3, !is.na(resultado)&tipo_toma==x)$resultado)[2],
                           "-", fivenum(filter(cv_oaxaca_t3, !is.na(resultado)&tipo_toma==x)$resultado)[4], ")"))
}



#Los primeros CD4 que se tomaron
cv_inicio_t3 <- cv_tiempo_t3("primera")

#CD4 más recientes tomados
cv_ultima_t3 <- cv_tiempo_t3("ultima")

#CD4 al ingreso
cv_ingreso_t3 <- cv_tiempo_t3("ingreso")


##########Carga viral indetectable
cv_indetectable_t3 <- function(x, y){
  if(y==50){
  c(str_c(sum(filter(cv_oaxaca_t3, ano_ingreso=="2018"&tipo_toma==x)$indetectable_50==T), " (", 
                                 round(sum(filter(cv_oaxaca_t3, ano_ingreso=="2018"&tipo_toma==x)$indetectable_50==T)/
                                         nrow(filter(cv_oaxaca_t3, ano_ingreso=="2018"&tipo_toma==x)), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(cv_oaxaca_t3, ano_ingreso=="2019"&tipo_toma==x)$indetectable_50==T), " (", 
                                 round(sum(filter(cv_oaxaca_t3, ano_ingreso=="2019"&tipo_toma==x)$indetectable_50==T)/
                                         nrow(filter(cv_oaxaca_t3, ano_ingreso=="2019"&tipo_toma==x)), 3)*100, "%)"),
                           #
                           str_c(sum(filter(cv_oaxaca_t3, ano_ingreso=="2020"&tipo_toma==x)$indetectable_50==T), " (", 
                                 round(sum(filter(cv_oaxaca_t3, ano_ingreso=="2020"&tipo_toma==x)$indetectable_50==T)/
                                         nrow(filter(cv_oaxaca_t3, ano_ingreso=="2020"&tipo_toma==x)), 3)*100, "%)"),
                           #
                           str_c(sum(filter(cv_oaxaca_t3,ano_ingreso=="2021"&tipo_toma==x)$indetectable_50==T), " (", 
                                 round(sum(filter(cv_oaxaca_t3, ano_ingreso=="2021"&tipo_toma==x)$indetectable_50==T)/
                                         nrow(filter(cv_oaxaca_t3, ano_ingreso=="2021"&tipo_toma==x)), 3)*100, "%)"),
                           #
                           str_c(sum(cv_oaxaca_t3$indetectable_50==T), " (", 
                                 round(sum(cv_oaxaca_t3$indetectable_50==T)/
                                         nrow(cv_oaxaca_t3), 3)*100, "%)"))
  }else{
      c(str_c(sum(filter(cv_oaxaca_t3, ano_ingreso=="2018"&tipo_toma==x)$indetectable_200==T), " (", 
                                 round(sum(filter(cv_oaxaca_t3, ano_ingreso=="2018"&tipo_toma==x)$indetectable_200==T)/
                                         nrow(filter(cv_oaxaca_t3, ano_ingreso=="2018"&tipo_toma==x)), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(cv_oaxaca_t3, ano_ingreso=="2019"&tipo_toma==x)$indetectable_200==T), " (", 
                                 round(sum(filter(cv_oaxaca_t3, ano_ingreso=="2019"&tipo_toma==x)$indetectable_200==T)/
                                         nrow(filter(cv_oaxaca_t3, ano_ingreso=="2019"&tipo_toma==x)), 3)*100, "%)"),
                           #
                           str_c(sum(filter(cv_oaxaca_t3, ano_ingreso=="2020"&tipo_toma==x)$indetectable_200==T), " (", 
                                 round(sum(filter(cv_oaxaca_t3, ano_ingreso=="2020"&tipo_toma==x)$indetectable_200==T)/
                                         nrow(filter(cv_oaxaca_t3, ano_ingreso=="2020"&tipo_toma==x)), 3)*100, "%)"),
                           #
                           str_c(sum(filter(cv_oaxaca_t3,ano_ingreso=="2021"&tipo_toma==x)$indetectable_200==T), " (", 
                                 round(sum(filter(cv_oaxaca_t3, ano_ingreso=="2021"&tipo_toma==x)$indetectable_200==T)/
                                         nrow(filter(cv_oaxaca_t3, ano_ingreso=="2021"&tipo_toma==x)), 3)*100, "%)"),
                           #
                           str_c(sum(cv_oaxaca_t3$indetectable_200==T), " (", 
                                 round(sum(cv_oaxaca_t3$indetectable_200==T)/
                                         nrow(cv_oaxaca_t3), 3)*100, "%)"))
  }
}
#Carga viral más reciente (sólo si al menos 6 meses de seguimiento)
cv_indetectable_inicial_50_t3 <- cv_indetectable_t3(x="primera", y=50)
cv_indetectable_inicial_200_t3 <- cv_indetectable_t3(x="primera", y=200)

#Carga viral más reciente (sólo si al menos 6 meses de seguimiento)
cv_indetectable_ultima_50_t3 <- cv_indetectable_t3(x="ultima", y=50)
cv_indetectable_ultima_200_t3 <- cv_indetectable_t3(x="ultima", y=200)

#Carga viral más reciente (sólo si al menos 6 meses de seguimiento)
cv_indetectable_ingreso_50_t3 <- cv_indetectable_t3(x="ingreso", y=50)
cv_indetectable_ingreso_200_t3 <- cv_indetectable_t3(x="ingreso", y=200)

####TABLA 2 
table_3 <- data.frame(ano_diagnostico=year_t,
                      #####################
                      paciente_tipo=paciente_tipo_t3,
                      #####################
                      paciente_sexo=rep("-", times=5),
                      #####################
                      paciente_sexo_mujer=paciente_sexo_fem_t3,
                      #####################
                      paciente_sexo_masc=paciente_sexo_masc_t3,
                      #####################
                      paciente_sexo_mujtrans=paciente_sexo_mujtrans_t3,
                      #####################
                      paciente_edad=paciente_edad_t3,
                      #####################
                      paciente_embarazada=paciente_embarazada_t3,
                      #####################
                      paciente_privada_libertad=paciente_privada_t3,
                      #####################
                      paciente_estatus=rep("-", times=5),
                      #####################
                      paciente_estatus_activo=paciente_estatus_activo_t3,
                      #####################
                      paciente_estatus_baja=paciente_estatus_baja_t3,
                      #####################
                      paciente_estatus_en_derivacion=paciente_estatus_derivacion_t3,
                      #####################
                      paciente_estatus_suspension=paciente_estatus_suspension_t3,
                      #####################
                      paciente_tratamiento= tratamiento_tab3,
                      #####################
                      paciente_centro=rep("-", times=5),
                      #####################
                      paciente_centro_oaxaca= centro_oaxaca_t3,
                      #####################
                      paciente_centro_salina=centro_salina_t3,
                      #####################
                      conteo_cd4=rep("-", times=5),
                    #####################
                      cd4_inicio=cd4_inicio_t3,
                    #####################
                    cd4_ingreso=cd4_ingreso_t3,
                    #####################
                    cd4_ultimos=cd4_ultima_t3,
                    #####################
                      carga_viral=rep("-", times=5),
                    #####################
                      cv_inicio=cv_inicio_t3,
                    #####################
                    cv_ingreso=cv_ingreso_t3,
                    #####################
                    cv_ultimos=cv_ultima_t3,
                    #####################
                      cv_inicio_indetect_50=cv_indetectable_inicial_50_t3,
                      cv_inicio_indetect_200=cv_indetectable_inicial_200_t3,
                    #####################
                    cv_ingreso_indetect_50=cv_indetectable_ingreso_50_t3,
                      cv_ingreso_indetect_200=cv_indetectable_ingreso_200_t3,
                    #####################
                    cv_ultima_indetect_50=cv_indetectable_ultima_50_t3,
                      cv_ultima_indetect_200=cv_indetectable_ultima_200_t3
                      )
                      

View(table_3)
```


```{r figura 3 a y b, include= F, echo= F, warning=F}

#División únicamente por año
capasits_oaxaca_reciente_figura_not <- capasits_oaxaca_t3 %>% 
  mutate(ano_notificacion= factor(year(paciente_notificacion))) %>% 
  group_by(ano_notificacion, paciente_sai) %>% 
  count()


capasits_oaxaca_reciente_figura_not <- ggplot(capasits_oaxaca_reciente_figura_not, aes(x= as.integer(n), y=ano_notificacion, colour=paciente_sai))+
  geom_segment(aes(yend = ano_notificacion), xend = 0, colour = "grey50")+
  geom_point(size = 3)+
  ggtitle("")+
  theme_bw()+
  ylab("Año de diagnóstico")+
  xlab("# de pacientes")+
  theme(panel.grid.major.y = element_blank(),
        legend.title=element_blank(),
        legend.position=c(0.4,0.3),
        legend.text = element_text(size=7.5))+
  scale_colour_viridis(discrete=TRUE)
  

#División por sexo
capasits_oaxaca_reciente_figura_s_not <- capasits_oaxaca_t3 %>% 
  mutate(ano_notificacion= factor(year(paciente_notificacion)),
         paciente_sexo= case_when(paciente_sexo=="F"~"Mujer cis",
                                  paciente_sexo=="M"~"Hombre cis",
                                  paciente_sexo=="TF"~"Mujer trans",
                                  paciente_sexo=="TM"~"Hombre trans")) %>% 
  group_by(ano_notificacion, paciente_sexo, paciente_sai) %>% 
  count()

capasits_oaxaca_reciente_figura_s_not <- ggplot(capasits_oaxaca_reciente_figura_s_not, aes(x= as.integer(n), y=ano_notificacion, colour=paciente_sexo))+
  geom_segment(aes(yend = ano_notificacion), xend = 0, colour = "grey50")+
  geom_point( size = 3)+
  ggtitle("")+
  theme_bw()+
  ylab("")+
  xlab("# de pacientes")+
  theme(panel.grid.major.y = element_blank(),
          legend.title=element_blank(),
        legend.position=c(0.7,0.2))+
scale_colour_viridis(discrete=TRUE)+
  facet_wrap(~paciente_sai, nrow=2)
  
figura_3 <- capasits_oaxaca_reciente_figura_not+capasits_oaxaca_reciente_figura_s_not+plot_annotation(tag_levels='A')


ggsave(plot = figura_3, width = 6.1, height = 6.5, dpi = 300, filename = "figura_3.png")


```
![Figura 3](figura_3.png)

```{r figura 4 series de tiempo, include =F, warning=F}
capasits_ingreso_por_dia <- group_by(capasits_oaxaca_2018_2021, paciente_ingreso) %>% 
  count()



plot_ingreso <- ggplot(capasits_ingreso_por_dia, aes(x = paciente_ingreso, y = n))+
  geom_point( size = 1, alpha = 0.5)+
  geom_vline(xintercept = ymd("2020-02-28"),
             colour = "darkred",
             size = 1.5)+
  scale_x_date(date_breaks = "2 month",
               date_labels ="%b %y")+
  scale_y_continuous(limits = c(0,10),
                     breaks = seq(from = 0, to = 10, by =1))+
  theme_bw()+
  labs(y="Número de pacientes por día",
       x="Fecha")+
    geom_smooth(colour = "red", fill = "violet", se = T, method = 'glm', method.args = list(family = 'poisson'),
              formula = y~splines::ns(x,20))+
  theme(axis.text.x = element_text(angle = 90, vjust = .25, hjust = 0.95, 
                               size = 12, face = "bold", colour="black"),
        axis.title.x = element_text(face = "bold", size = 14),
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.y = element_text(face = "bold", size = 14),
        axis.text.y = element_text(size = 14, face = "bold", colour = "black"),
        plot.title = element_text(size = 14, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"))


#GRÁFICAS DE DIAGNÓSTICO
capasits_diagnostico_por_dia <- group_by(capasits_oaxaca_t3, paciente_ingreso) %>% 
  count()



plot_diagnosticos <- ggplot(capasits_diagnostico_por_dia, aes(x = paciente_ingreso, y = n))+
  geom_point( size = 1, alpha = 0.5)+
  geom_vline(xintercept = ymd("2020-02-28"),
             colour = "darkred",
             size = 1.5)+
  scale_x_date(date_breaks = "2 month",
               date_labels ="%b %y")+
  scale_y_continuous(limits = c(0,5),
                     breaks = seq(from = 0, to = 5, by =1))+
  theme_bw()+
  labs(y="", x="Fecha")+
    geom_smooth(colour = "red", fill = "violet", se = T, method = 'glm', method.args = list(family = 'poisson'),
              formula = y~splines::ns(x,20))+
  theme(axis.text.x = element_text(angle = 90, vjust = .25, hjust = 0.95, 
                               size = 12, face = "bold", colour="black"),
        axis.title.x = element_text(face = "bold", size = 14),
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.y = element_text(face = "bold", size = 14),
        axis.text.y = element_text(size = 14, face = "bold", colour = "black"),
        plot.title = element_text(size = 14, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"))


figura_4 <- plot_ingreso+plot_diagnosticos+plot_annotation(tag_levels="A")

ggsave(plot = figura_4, width = 9, height = 5, dpi = 300, filename = "figura_4.png")
```
![Figura 4](figura_4.png)

```{r  regresión logística para el desenlace de supresión virológica, include = F, warning= F}
cv_log_ingreso <- filter(cv_oaxaca_t2, tipo_toma=="ultima") %>% 
  mutate(fecha_dif_tomas =fecha_toma-paciente_ingreso) %>% 
  filter(fecha_dif_tomas>=180)

capasits_oaxaca_log_ingreso <- capasits_oaxaca_t2 %>% 
  left_join(select(cv_log_ingreso, id_paciente, indetectable_200) %>% mutate(id_paciente=as.character(id_paciente)), by ="id_paciente") %>% 
  filter(!is.na(indetectable_200))


set.seed(1)

ind <- sample(c(0,1), nrow(capasits_oaxaca_log_ingreso), replace = T, prob= c(0.7, 0.3))

train <- capasits_oaxaca_log_ingreso[ind==1,]
test <- capasits_oaxaca_log_ingreso[ind==2,]



#EDAD DESENLACE HOSPITALIZACIÓN SATURACION HOSPITALARIA INTUBACION MISMA FECHA

mymodel_cd4 <- glm(indetectable_200 ~ rcs(cd4_resultado, 3)+rcs(paciente_edad, 3)+paciente_sexo, 
                          data = train, family = 'binomial')
summary(mymodel_cd4)
exp(coef(mymodel_cd4))
exp(coef(mymodel_cd4)-(1.96*0.002))
exp(coef(mymodel_cd4)+(1.96*0.002))

lr_cd4 <- termplot(mymodel_cd4, se=TRUE, plot = F)$cd4
center_cd4 <- with(lr_cd4, y[x==198])
ci_cd4 <- lr_cd4$y + outer(lr_cd4$se, c(0, -1.96, 1.96), '*')

cd4_df <- data.frame(cd4 = lr_cd4$x, 
                     y = lr_cd4$y,
                     se = lr_cd4$se,
                     lower_ci = ci_cd4[,2],
                     upper_ci = ci_cd4[,3],
                     mean_ci = ci_cd4[,1])


cd4_ors <- cd4_df[with(cd4_df, cd4 == 53 | cd4 == 98 | cd4 == 198 | 
                         cd4 == 300 |cd4== 500),] %>% 
  mutate(or = round(exp(y-center_cd4),2),
         lower_or = round(exp(lower_ci-center_cd4),2),
         upper_or = round(exp(upper_ci-center_cd4),2),
         full_or = str_c(round(exp(y-center_cd4),2), " (", round(exp(lower_ci-center_cd4),2),
                         "-", round(exp(upper_ci-center_cd4),2),")"))




cd4_spline_plot <- ggplot(cd4_df, aes(x = cd4, 
                                                        y = exp(y - center_cd4))) +
  geom_hline(yintercept = seq(from = 0, to = 10, by = 2), colour = "lightgray") +
  geom_hline(yintercept=1, colour = "black", size = .7)+
  geom_smooth(se = F, colour = "darkred", size = 1.2) +
  geom_smooth(se = F, colour = "darkred", linetype = "dashed", 
              aes(y = exp(upper_ci - center_cd4)), size = .8) +
  geom_smooth(se = F, colour = "darkred", linetype = "dashed", 
              aes(y = exp(lower_ci - center_cd4)), size = .8) +
  ylab("Odds ratio de supresión viral") +
  xlab("Conteo de CD4")+
  theme_light()+
  theme(axis.text.x = element_text(size = 14, face = "bold", colour="black"),
        axis.title.x = element_text(face = "bold", size = 14),
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.y = element_text(face = "bold", size = 14),
        axis.text.y = element_text(size = 14, face = "bold", colour = "black"),
        plot.title = element_text(size = 14, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"))+
  scale_y_continuous(limits = c(0, 10))+
  scale_x_continuous(breaks = seq(0,600,100),
                     limits = c(0, 600))


#AÑO DE INGRESO
mymodel_year <- glm(indetectable_200 ~ ano_ingreso+rcs(cd4_resultado, 3)+rcs(paciente_edad, 3)+paciente_sexo, 
                          data = train, family = 'binomial')
summary(mymodel_year)
exp(coef(mymodel_year))
exp(coef(mymodel_year)-(1.96*0.002))
exp(coef(mymodel_year)+(1.96*0.002))

lr_year <- termplot(mymodel_year, se=TRUE, plot = F)$ano_ingreso
center_year <- with(lr_year, y[x==2019])
ci_year <- lr_year$y + outer(lr_year$se, c(0, -1.96, 1.96), '*')

year_df <- data.frame(year = lr_year$x, 
                     y = lr_year$y,
                     se = lr_year$se,
                     lower_ci = ci_year[,2],
                     upper_ci = ci_year[,3],
                     mean_ci = ci_year[,1])


year_ors <- year_df[with(year_df, year == 2018 | year == 2019 | year == 2020|year == 2021),] %>% 
  mutate(or = round(exp(y-center_year),2),
         lower_or = round(exp(lower_ci-center_year),2),
         upper_or = round(exp(upper_ci-center_year),2),
         full_or = str_c(round(exp(y-center_year),2), " (", round(exp(lower_ci-center_year),2),
                         "-", round(exp(upper_ci-center_year),2),")"))



```

