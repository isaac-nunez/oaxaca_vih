---
title: "Oaxaca ONUSIDA"
author: "Isaac Núñez, Yanink Caro Vega"
output:
  word_document: default
  html_document:
    df_print: paged
---

```{r first, include = F, warning=F}
setwd("C:/Users/isaac/OneDrive/Documentos/Protocolos_de_investigacion/Chiapas-Oaxaca ONUSIDA")


```


```{r first chunk, include = F, warning=F}
library(tidyverse);library(lubridate); library(readxl);library(viridis);library(data.table);library(devtools); library(flextable);
library(patchwork)
#library(mxmaps)


#capasits_oaxaca <- read_excel("base_oaxaca_21.xlsx")


load("~/Protocolos_de_investigacion/Chiapas-Oaxaca ONUSIDA/chiapas_onusida/oaxaca_vih/capasits_oaxaca.Rda")
#plantilla_capasits <- read_excel("PLANTILLA POR CAPASITS DE OAXACA2.xlsx")
cd4_oaxaca <- read_excel("cd4_oaxaca.xlsx")
cv_oaxaca <- read_excel("carga_viral_oaxaca.xlsx")
```


```{r base capasits oaxaca, include = F, warning=F, run = F}
capasits_oaxaca <- capasits_oaxaca %>% 
  mutate(id_paciente=as.character(id_paciente),
         paciente_ultima_consulta = ymd(paciente_ultima_consulta),
         paciente_notificacion = ymd(paciente_notificacion),
         paciente_ingreso = ymd(paciente_ingreso),
         paciente_fecha_defuncion = ymd(paciente_fecha_defuncion),
         paciente_fecha_alta = ymd(substr(paciente_fecha_alta, 1, 10)),
         paciente_f_ultimo_estatus = ymd(substr(paciente_f_ultimo_estatus, 1, 10)),
         esquema_fecha_inicio = ymd(esquema_fecha_inicio),
         cv_fecha_estudio = ymd(cv_fecha_estudio))

#save(capasits_oaxaca, file="capasits_oaxaca.Rda")

## Análisis exploratorio breve sobre capasits_oaxaca 
glimpse(capasits_oaxaca)
table(capasits_oaxaca$paciente_sexo)
n_distinct(capasits_oaxaca$id_paciente)
range(capasits_oaxaca$paciente_ingreso, na.rm = T)
range(capasits_oaxaca$paciente_f_ultimo_estatus, na.rm = T)
sum(is.na(capasits_oaxaca$paciente_ingreso))
sum(is.na(capasits_oaxaca$paciente_notificacion))
sum(capasits_oaxaca$paciente_estatus=="ACTIVO")

#Pacientes de cd4_oaxaca y cv_oaxaca que están presentes en capasits_oaxaca
n_distinct(filter(cd4_oaxaca, id_paciente%in%capasits_oaxaca$id_paciente)$id_paciente)
n_distinct(filter(cv_oaxaca, id_paciente%in%capasits_oaxaca$id_paciente)$id_paciente)


n_distinct(filter(cd4_oaxaca, id_paciente%in%filter(cv_oaxaca, id_paciente%in%capasits_oaxaca$id_paciente)$id_paciente)$id_paciente)
```


```{r tabla 1, run = F, include = F, warning=F}
#Construiremos las variables que compondrán la tabla por separado para que sea más manejable


#Género de los pacientes
genero_t <- c("Mujer cis", "Hombre cis", "Mujer trans", "Hombre trans", "Todos")

#Tipo de pacientes (todos son en trataimento ARV)
paciente_tipo_t <- c(str_c(sum(capasits_oaxaca$paciente_sexo=="F"), " (", round(sum(capasits_oaxaca$paciente_sexo=="F")/nrow(capasits_oaxaca), 3)*100, "%)"),
                                      str_c(sum(capasits_oaxaca$paciente_sexo=="M"), " (", round(sum(capasits_oaxaca$paciente_sexo=="M")/nrow(capasits_oaxaca), 3)*100, "%)"),
                                      str_c(sum(capasits_oaxaca$paciente_sexo=="TF"), " (", round(sum(capasits_oaxaca$paciente_sexo=="TF")/nrow(capasits_oaxaca), 3)*100, "%)"),
                                      str_c(sum(capasits_oaxaca$paciente_sexo=="TM"), " (", round(sum(capasits_oaxaca$paciente_sexo=="TM")/nrow(capasits_oaxaca), 3)*100, "%)"),
                                      str_c(nrow(capasits_oaxaca), " (100%)"))

#Sexo de los pacientes
paciente_sexo_t <- c(str_c(sum(capasits_oaxaca$paciente_sexo=="F"), " (", round(sum(capasits_oaxaca$paciente_sexo=="F")/nrow(capasits_oaxaca), 3)*100, "%)"),
                                      str_c(sum(capasits_oaxaca$paciente_sexo=="M"), " (", round(sum(capasits_oaxaca$paciente_sexo=="M")/nrow(capasits_oaxaca), 3)*100, "%)"),
                                      str_c(sum(capasits_oaxaca$paciente_sexo=="TF"), " (", round(sum(capasits_oaxaca$paciente_sexo=="TF")/nrow(capasits_oaxaca), 3)*100, "%)"),
                                      str_c(sum(capasits_oaxaca$paciente_sexo=="TM"), " (", round(sum(capasits_oaxaca$paciente_sexo=="TM")/nrow(capasits_oaxaca), 3)*100, "%)"),
                                      str_c(nrow(capasits_oaxaca), " (100%)"))

#Edad de los pacientes (mediana y rango IQR)
paciente_edad_t <- c(str_c(median(filter(capasits_oaxaca, paciente_sexo=="F"&!is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca, paciente_sexo=="F"&!is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca, paciente_sexo=="F"&!is.na(paciente_edad))$paciente_edad)[4], ")"),
                     str_c(median(filter(capasits_oaxaca, paciente_sexo=="F"&!is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca, paciente_sexo=="M"&!is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca, paciente_sexo=="M"&!is.na(paciente_edad))$paciente_edad)[4], ")"),
                     str_c(median(filter(capasits_oaxaca, paciente_sexo=="F"&!is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca, paciente_sexo=="TF"&!is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca, paciente_sexo=="TF"&!is.na(paciente_edad))$paciente_edad)[4], ")"),
                     str_c(median(filter(capasits_oaxaca, paciente_sexo=="F"&!is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca, paciente_sexo=="TM"&!is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca, paciente_sexo=="TM"&!is.na(paciente_edad))$paciente_edad)[4], ")"),
                     str_c(median(filter(capasits_oaxaca, !is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca, !is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca, !is.na(paciente_edad))$paciente_edad)[4], ")"))


#Si la paciente estaba o no embarazada
paciente_embarazada_t <- c(str_c(sum(capasits_oaxaca$paciente_vih_embarazada=="SI"), " (", 
                                                  (round(sum(capasits_oaxaca$paciente_vih_embarazada=="SI")/sum(capasits_oaxaca$paciente_sexo=="F"), 3)*100), "%)"), rep("0 (0%)", times=3),
                                            str_c(sum(capasits_oaxaca$paciente_vih_embarazada=="SI"), " (", 
                                                  (round(sum(capasits_oaxaca$paciente_vih_embarazada=="SI")/nrow(capasits_oaxaca), 3)*100), "%)"))


#Si la paciente estaba privada de su libertad
paciente_privada_t <- c(str_c(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_priv_libertad=="S"), " (", round(sum(capasits_oaxaca$paciente_sexo=="F"&
                                                                                                                                     capasits_oaxaca$paciente_priv_libertad=="S")
                                                                                                                                         /sum(capasits_oaxaca$paciente_sexo=="F"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="M"&
                                                              capasits_oaxaca$paciente_priv_libertad=="S"), " (", round(sum(capasits_oaxaca$paciente_sexo=="M"&
                                                                                                                              capasits_oaxaca$paciente_priv_libertad=="S")
                                                                                                                                         /sum(capasits_oaxaca$paciente_sexo=="M"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TF"&
                                                              capasits_oaxaca$paciente_priv_libertad=="S"), " (", round(sum(capasits_oaxaca$paciente_sexo=="TF"&
                                                                                                                              capasits_oaxaca$paciente_priv_libertad=="S")
                                                                                                                                          /sum(capasits_oaxaca$paciente_sexo=="TF"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TM"&
                                                              capasits_oaxaca$paciente_priv_libertad=="S"), " (", round(sum(capasits_oaxaca$paciente_sexo=="TM"&
                                                                                                                              capasits_oaxaca$paciente_priv_libertad=="S")
                                                                                                                                          /sum(capasits_oaxaca$paciente_sexo=="TM"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_priv_libertad=="S"), " (", round(sum(capasits_oaxaca$paciente_priv_libertad=="S")
                                                                                                                      /nrow(capasits_oaxaca), 3)*100, "%)"))

#Si los pacientes tenían estatus de activo, desglosado por género
paciente_estatus_activo_t <- c(str_c(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_estatus=="ACTIVO"), " (",
                                                      round(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_estatus=="ACTIVO")/sum(capasits_oaxaca$paciente_sexo=="F"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_estatus=="ACTIVO"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_estatus=="ACTIVO")/sum(capasits_oaxaca$paciente_sexo=="M"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_estatus=="ACTIVO"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_estatus=="ACTIVO")/sum(capasits_oaxaca$paciente_sexo=="TF"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_estatus=="ACTIVO"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_estatus=="ACTIVO")/sum(capasits_oaxaca$paciente_sexo=="TM"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_estatus=="ACTIVO"), " (", round(sum(capasits_oaxaca$paciente_estatus=="ACTIVO")
                                                                                                                      /nrow(capasits_oaxaca), 3)*100, "%)"))

#Si los pacientes tenían estatus de baja, desglosado por género
paciente_estatus_baja_t <- c(str_c(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_estatus=="BAJA"), " (",
                                                      round(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_estatus=="BAJA")/sum(capasits_oaxaca$paciente_sexo=="F"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_estatus=="BAJA"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_estatus=="BAJA")/sum(capasits_oaxaca$paciente_sexo=="M"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_estatus=="BAJA"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_estatus=="BAJA")/sum(capasits_oaxaca$paciente_sexo=="TF"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_estatus=="BAJA"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_estatus=="BAJA")/sum(capasits_oaxaca$paciente_sexo=="TM"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_estatus=="BAJA"), " (", round(sum(capasits_oaxaca$paciente_estatus=="BAJA")
                                                                                                                      /nrow(capasits_oaxaca), 3)*100, "%)"))


#Si los pacientes tenían estatus de derivación, desglosado por género

paciente_estatus_derivacion_t <- c(str_c(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (",
                                                      round(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")/sum(capasits_oaxaca$paciente_sexo=="F"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")/sum(capasits_oaxaca$paciente_sexo=="M"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")/sum(capasits_oaxaca$paciente_sexo=="TF"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")/sum(capasits_oaxaca$paciente_sexo=="TM"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (", round(sum(capasits_oaxaca$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")
                                                                                                                      /nrow(capasits_oaxaca), 3)*100, "%)"))


#Si los pacientes tenían estatus de suspensión, desglosado por género
paciente_estatus_suspension_t <- c(str_c(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_estatus=="EN SUSPENSION"), " (",
                                                      round(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_estatus=="EN SUSPENSION")/sum(capasits_oaxaca$paciente_sexo=="F"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_estatus=="EN SUSPENSION"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_estatus=="EN SUSPENSION")/sum(capasits_oaxaca$paciente_sexo=="M"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_estatus=="EN SUSPENSION"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_estatus=="EN SUSPENSION")/sum(capasits_oaxaca$paciente_sexo=="TF"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_estatus=="EN SUSPENSION"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_estatus=="EN SUSPENSION")/sum(capasits_oaxaca$paciente_sexo=="TM"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_estatus=="EN SUSPENSION"), " (", round(sum(capasits_oaxaca$paciente_estatus=="EN SUSPENSION")
                                                                                                                      /nrow(capasits_oaxaca), 3)*100, "%)"))



#Tratamiento para incluir en la tabla
 tratamiento <- group_by(capasits_oaxaca, paciente_sexo, esquema) %>% 
   count() %>% 
   arrange(desc(n)) %>% 
   ungroup() %>% 
   group_by(paciente_sexo) %>% 
   slice(1)

tratamiento_whole <- group_by(capasits_oaxaca, esquema) %>% 
  count() %>% 
  arrange(desc(n)) 


tratamiento_t <- c(str_c(tratamiento$esquema, " ", tratamiento$n), str_c(tratamiento_whole$esquema[1], " ", tratamiento_whole$n[1]))

#Centro en donde reciben la atención
centro_oaxaca <- c(str_c(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_sai=="CAPASITS - Oaxaca"), " (",
                                                      round(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_sai=="CAPASITS - Oaxaca")/sum(capasits_oaxaca$paciente_sexo=="F"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_sai=="CAPASITS - Oaxaca"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_sai=="CAPASITS - Oaxaca")/sum(capasits_oaxaca$paciente_sexo=="M"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_sai=="CAPASITS - Oaxaca"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_sai=="CAPASITS - Oaxaca")/sum(capasits_oaxaca$paciente_sexo=="TF"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_sai=="CAPASITS - Oaxaca"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_sai=="CAPASITS - Oaxaca")/sum(capasits_oaxaca$paciente_sexo=="TM"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sai=="CAPASITS - Oaxaca"), " (", round(sum(capasits_oaxaca$paciente_sai=="CAPASITS - Oaxaca")
                                                                                                                      /nrow(capasits_oaxaca), 3)*100, "%)"))


centro_salina <- c(str_c(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_sai=="CAPASITS - Salina Cruz"), " (",
                                                      round(sum(capasits_oaxaca$paciente_sexo=="F"&capasits_oaxaca$paciente_sai=="CAPASITS - Salina Cruz")/sum(capasits_oaxaca$paciente_sexo=="F"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_sai=="CAPASITS - Salina Cruz"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="M"&capasits_oaxaca$paciente_sai=="CAPASITS - Salina Cruz")/sum(capasits_oaxaca$paciente_sexo=="M"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_sai=="CAPASITS - Salina Cruz"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TF"&capasits_oaxaca$paciente_sai=="CAPASITS - Salina Cruz")/sum(capasits_oaxaca$paciente_sexo=="TF"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_sai=="CAPASITS - Salina Cruz"), " (",
                                                        round(sum(capasits_oaxaca$paciente_sexo=="TM"&capasits_oaxaca$paciente_sai=="CAPASITS - Salina Cruz")/sum(capasits_oaxaca$paciente_sexo=="TM"), 3)*100, "%)"),
                                                  str_c(sum(capasits_oaxaca$paciente_sai=="CAPASITS - Salina Cruz"), " (", round(sum(capasits_oaxaca$paciente_sai=="CAPASITS - Salina Cruz")
                                                                                                                      /nrow(capasits_oaxaca), 3)*100, "%)"))


####TABLA 1 
table_1 <- data.frame(genero=genero_t,
                      #####################
                      paciente_tipo=paciente_tipo_t,
                      #####################
                      paciente_sexo=paciente_sexo_t,
                      #####################
                      paciente_edad=paciente_edad_t,
                      #####################
                      paciente_embarazada=paciente_embarazada_t,
                      #####################
                      paciente_privada_libertad=paciente_privada_t,
                      #####################
                      paciente_estatus=rep("-", times=5),
                      #####################
                      paciente_estatus_activo=paciente_estatus_activo_t,
                      #####################
                      paciente_estatus_baja=paciente_estatus_baja_t,
                      #####################
                      paciente_estatus_en_derivacion=paciente_estatus_derivacion_t,
                      #####################
                      paciente_estatus_suspension=paciente_estatus_suspension_t,
                      #####################
                      paciente_tratamiento= tratamiento_t,
                      #####################
                      paciente_centro=rep("-", times=5),
                      #####################
                      paciente_centro_oaxaca= centro_oaxaca,
                      #####################
                      paciente_centro_salina=centro_salina
                      )


View(table_1)


```


Recibimos la base *OAXACA PROYECTO 21*, la cual incluye información sobre todo paciente que recibe atención en el sistema CAPASITS del estado de Oaxaca. De aquí en adelante, nos referiremos a dicha base con el nombre *capasits_oaxaca*, la cual será nuestra base de trabajo. La base cuenta con `r ncol(capasits_oaxaca)` variables y `r nrow(capasits_oaxaca)` observaciones. Las variables incluídas son: `r names(capasits_oaxaca)`. Se encontró un total de `r n_distinct(capasits_oaxaca$id_paciente)` pacientes (únicamente uno con una observación repetida), de los cuales `r sum(capasits_oaxaca$paciente_estatus=="ACTIVO")` se encuentran activos en el sistema CAPASITS (`r round((sum(capasits_oaxaca$paciente_estatus=="ACTIVO")/n_distinct(capasits_oaxaca$id_paciente))*100, 1)`%). Del total de pacientes, `r sum(capasits_oaxaca$paciente_sexo=="F")` son mujeres cis,  `r sum(capasits_oaxaca$paciente_sexo=="M")` son hombres cis, `r sum(capasits_oaxaca$paciente_sexo=="TF")` son mujeres trans y una persona es hombre trans. El rango de fechas de ingreso al sistema CAPASITS fue del `r range(capasits_oaxaca$paciente_ingreso, na.rm = T)[1]` al `r range(capasits_oaxaca$paciente_ingreso, na.rm = T)[2]`. En la **Figura 1A** se muestra el total de pacientes que ingresaron por año, mientras que en la **Figura 1B** se muestra el total de pacientes que ingresaron por año y por género. La fecha en la cual se registró la última consulta fue el `r range(capasits_oaxaca$paciente_f_ultimo_estatus, na.rm = T)[2]`.  

```{r figura 1 a y b, include= F, echo= F, warning=F}

#División únicamente por año
capasits_oaxaca_figura <- capasits_oaxaca %>% 
  mutate(ano_ingreso= factor(year(paciente_ingreso))) %>% 
  group_by(ano_ingreso) %>% 
  count()


capasits_oaxaca_figura_plot <- ggplot(capasits_oaxaca_figura, aes(x= as.integer(n), y=ano_ingreso))+
  geom_segment(aes(yend = ano_ingreso), xend = 0, colour = "grey50")+
  geom_point(size = 3)+
  ggtitle("")+
  theme_bw()+
  ylab("Año de ingreso")+
  xlab("# de pacientes")+
  theme(panel.grid.major.y = element_blank())+
  scale_colour_viridis(discrete=TRUE)
  

#División por sexo
capasits_oaxaca_figura_s <- capasits_oaxaca %>% 
  mutate(ano_ingreso= factor(year(paciente_ingreso)),
         paciente_sexo= case_when(paciente_sexo=="F"~"Mujer cis",
                                  paciente_sexo=="M"~"Hombre cis",
                                  paciente_sexo=="TF"~"Mujer trans",
                                  paciente_sexo=="TM"~"Hombre trans")) %>% 
  group_by(ano_ingreso, paciente_sexo) %>% 
  count()

capasits_oaxaca_figura_plot_s <- ggplot(capasits_oaxaca_figura_s, aes(x= as.integer(n), y=ano_ingreso, colour=paciente_sexo))+
  geom_segment(aes(yend = ano_ingreso), xend = 0, colour = "grey50")+
  geom_point( size = 3)+
  ggtitle("")+
  theme_bw()+
  ylab("")+
  xlab("# de pacientes")+
  theme(panel.grid.major.y = element_blank(),
          legend.title=element_blank(),
        legend.position=c(0.7,0.2))+
scale_colour_viridis(discrete=TRUE)
  
figura_1 <- capasits_oaxaca_figura_plot+capasits_oaxaca_figura_plot_s+plot_annotation(tag_levels='A')


#ggsave(plot = figura_1, width = 6.1, height = 6.5, dpi = 300, filename = "figura_1.png")
```
![Figura 1](figura_1.png)
**Figura 1**. Número de pacientes que ingresaron cada año a CAPASITS Oaxaca en total (A) y desglosado por género (B).
</br>
</br>
</br>
</br>

Se recibieron además dos bases adicionales, las cuales incluyen información sobre todas las mediciones de linfocitos T CD4 y carga viral de VIH realizadas en pacientes de CAPASITS Oaxaca. En la base de linfocitos T CD4 (llamada *cd4_oaxaca*) hay información sobre `r n_distinct(cd4_oaxaca$id_paciente)` pacientes, mientras que en la de carga viral de VIH (llamada *cv_oaxaca*) hay información sobre `r n_distinct(cv_oaxaca$id_paciente)` pacientes. De los pacientes presentes en *capasits_oaxaca*, `r n_distinct(filter(cd4_oaxaca, id_paciente%in%capasits_oaxaca$id_paciente)$id_paciente)` (`r round(n_distinct(filter(cd4_oaxaca, id_paciente%in%capasits_oaxaca$id_paciente)$id_paciente)/n_distinct(capasits_oaxaca$id_paciente), 1)`%) tuvieron información sobre linfocitos T CD4 en la base *cd4_oaxaca*. Asimismo,  `r n_distinct(filter(cv_oaxaca, id_paciente%in%capasits_oaxaca$id_paciente)$id_paciente)` (`r round(n_distinct(filter(cv_oaxaca, id_paciente%in%capasits_oaxaca$id_paciente)$id_paciente)/n_distinct(capasits_oaxaca$id_paciente), 1)`%) tuvieron información sobre carga viral de VIH en *cv_oaxaca*. Todos los pacienes con información sobre carga viral también tuvieron información sobre linfocitos T CD4, de manera que hubo `r n_distinct(filter(cd4_oaxaca, id_paciente%in%capasits_oaxaca$id_paciente)$id_paciente)-n_distinct(filter(cv_oaxaca, id_paciente%in%capasits_oaxaca$id_paciente)$id_paciente)` más pacientes con información sobre linfocitos T CD4. En la **Tabla 1** se describen a detalle las características generales de los pacientes incluidos en la base *capasits_oaxaca*



```{r filtrando bases a pacientes que ingresaron durante 2018 a 2021, include=F, warning=F}
capasits_oaxaca_2018_2021 <- filter(capasits_oaxaca, paciente_ingreso>="2018-01-01")

capasits_oaxaca_2018_2021_not <- filter(capasits_oaxaca, paciente_notificacion>="2018-01-01")

capasits_oaxaca_2018_2019 <- filter(capasits_oaxaca, paciente_ingreso>="2018-01-01"&
                                      paciente_notificacion<="2020-02-27")

capasits_oaxaca_2018_2019_not <- filter(capasits_oaxaca, paciente_notificacion>="2018-01-01"&
                                      paciente_notificacion<="2020-02-27")

capasits_oaxaca_2020_2021 <- filter(capasits_oaxaca, paciente_ingreso>="2020-02-28")

capasits_oaxaca_2020_2021_not <- filter(capasits_oaxaca, paciente_notificacion>="2020-02-28")
```

La base *capasits_oaxaca* se filtró para incluir únicamente a los pacientes ingresados al sistema CAPASITS durante los años 2018 a 2021, resultando en la base *capasits_oaxaca_2018_2021*. Dicha base incluye a `r nrow(capasits_oaxaca_2018_2021)` PVVIH, de los cuales `r sum(capasits_oaxaca_2018_2021$paciente_estatus=="ACTIVO")` se encuentran activos en el sistema CAPASITS (`r round((sum(capasits_oaxaca_2018_2021$paciente_estatus=="ACTIVO")/n_distinct(capasits_oaxaca_2018_2021$id_paciente))*100, 1)`%). Del total de pacientes, `r sum(capasits_oaxaca_2018_2021$paciente_sexo=="F")` son mujeres cis,  `r sum(capasits_oaxaca_2018_2021$paciente_sexo=="M")` son hombres cis, `r sum(capasits_oaxaca_2018_2021$paciente_sexo=="TF")` son mujeres trans y una persona es hombre trans. Un total de `r sum(capasits_oaxaca_2018_2021$paciente_sai=="CAPASITS - Salina Cruz")` (`r round((sum(capasits_oaxaca_2018_2021$paciente_sai=="CAPASITS - Salina Cruz")/nrow(capasits_oaxaca_2018_2021)*100), 1)`%) ingresaron al CAPASITS de Salina Cruz, mientras que `r sum(capasits_oaxaca_2018_2021$paciente_sai=="CAPASITS - Oaxaca")` (`r round((sum(capasits_oaxaca_2018_2021$paciente_sai=="CAPASITS - Oaxaca")/nrow(capasits_oaxaca_2018_2021)*100), 1)`%) ingresaron a la capital del estado. La fecha en la cual se registró la última consulta fue el `r range(capasits_oaxaca_2018_2021$paciente_f_ultimo_estatus, na.rm = T)[2]`. En la **Figura 2A** se muestra el total de pacientes que ingresaron por año y por centro, mientras que en la **Figura 2B** se muestra el total de pacientes que ingresaron también desglosados por género.


```{r figura 2 a y b, include= F, echo= F, warning=F}

#División únicamente por año
capasits_oaxaca_reciente_figura <- capasits_oaxaca_2018_2021 %>% 
  mutate(ano_ingreso= factor(year(paciente_ingreso))) %>% 
  group_by(ano_ingreso, paciente_sai) %>% 
  count()


capasits_oaxaca_reciente_figura <- ggplot(capasits_oaxaca_reciente_figura, aes(x= as.integer(n), y=ano_ingreso, colour=paciente_sai))+
  geom_segment(aes(yend = ano_ingreso), xend = 0, colour = "grey50")+
  geom_point(size = 3)+
  ggtitle("")+
  theme_bw()+
  ylab("Año de diagnóstico")+
  xlab("# de pacientes")+
  theme(panel.grid.major.y = element_blank(),
        legend.title=element_blank(),
        legend.position=c(0.4,0.3),
        legend.text = element_text(size=7.5))+
  scale_colour_viridis(discrete=TRUE)
  

#División por sexo
capasits_oaxaca_reciente_figura_s <- capasits_oaxaca_2018_2021 %>% 
  mutate(ano_ingreso= factor(year(paciente_ingreso)),
         paciente_sexo= case_when(paciente_sexo=="F"~"Mujer cis",
                                  paciente_sexo=="M"~"Hombre cis",
                                  paciente_sexo=="TF"~"Mujer trans",
                                  paciente_sexo=="TM"~"Hombre trans")) %>% 
  group_by(ano_ingreso, paciente_sexo, paciente_sai) %>% 
  count()

capasits_oaxaca_reciente_figura_s <- ggplot(capasits_oaxaca_reciente_figura_s, aes(x= as.integer(n), y=ano_ingreso, colour=paciente_sexo))+
  geom_segment(aes(yend = ano_ingreso), xend = 0, colour = "grey50")+
  geom_point( size = 3)+
  ggtitle("")+
  theme_bw()+
  ylab("")+
  xlab("# de pacientes")+
  theme(panel.grid.major.y = element_blank(),
          legend.title=element_blank(),
        legend.position=c(0.7,0.2))+
scale_colour_viridis(discrete=TRUE)+
  facet_wrap(~paciente_sai, nrow=2)
  
figura_2 <- capasits_oaxaca_reciente_figura+capasits_oaxaca_reciente_figura_s+plot_annotation(tag_levels='A')


#ggsave(plot = figura_2, width = 6.1, height = 6.5, dpi = 300, filename = "figura_2.png")
```


![Figura 2](figura_2.png)

```{r figura 3 a y b, include= F, echo= F, warning=F}

#División únicamente por año
capasits_oaxaca_reciente_figura_not <- capasits_oaxaca_2018_2021_not %>% 
  mutate(ano_notificacion= factor(year(paciente_notificacion))) %>% 
  group_by(ano_notificacion, paciente_sai) %>% 
  count()


capasits_oaxaca_reciente_figura_not <- ggplot(capasits_oaxaca_reciente_figura_not, aes(x= as.integer(n), y=ano_notificacion, colour=paciente_sai))+
  geom_segment(aes(yend = ano_notificacion), xend = 0, colour = "grey50")+
  geom_point(size = 3)+
  ggtitle("")+
  theme_bw()+
  ylab("Año de diagnóstico")+
  xlab("# de pacientes")+
  theme(panel.grid.major.y = element_blank(),
        legend.title=element_blank(),
        legend.position=c(0.4,0.3),
        legend.text = element_text(size=7.5))+
  scale_colour_viridis(discrete=TRUE)
  

#División por sexo
capasits_oaxaca_reciente_figura_s_not <- capasits_oaxaca_2018_2021_not %>% 
  mutate(ano_notificacion= factor(year(paciente_notificacion)),
         paciente_sexo= case_when(paciente_sexo=="F"~"Mujer cis",
                                  paciente_sexo=="M"~"Hombre cis",
                                  paciente_sexo=="TF"~"Mujer trans",
                                  paciente_sexo=="TM"~"Hombre trans")) %>% 
  group_by(ano_notificacion, paciente_sexo, paciente_sai) %>% 
  count()

capasits_oaxaca_reciente_figura_s_not <- ggplot(capasits_oaxaca_reciente_figura_s_not, aes(x= as.integer(n), y=ano_notificacion, colour=paciente_sexo))+
  geom_segment(aes(yend = ano_notificacion), xend = 0, colour = "grey50")+
  geom_point( size = 3)+
  ggtitle("")+
  theme_bw()+
  ylab("")+
  xlab("# de pacientes")+
  theme(panel.grid.major.y = element_blank(),
          legend.title=element_blank(),
        legend.position=c(0.7,0.2))+
scale_colour_viridis(discrete=TRUE)+
  facet_wrap(~paciente_sai, nrow=2)
  
figura_3 <- capasits_oaxaca_reciente_figura_not+capasits_oaxaca_reciente_figura_s_not+plot_annotation(tag_levels='A')


#ggsave(plot = figura_3, width = 6.1, height = 6.5, dpi = 300, filename = "figura_3.png")


```
![Figura 3](figura_3.png)


```{r bases adicionales de 2018-2021 cd4 y carga viral, include = F, warning=F}
cd4_oaxaca_2018_2021 <- read_excel("cd4_oaxaca.xlsx") %>% 
  filter(id_paciente%in%capasits_oaxaca_2018_2021$id_paciente)

cd4_oaxaca_2018_2019 <- read_excel("cd4_oaxaca.xlsx") %>% 
  filter(id_paciente%in%capasits_oaxaca_2018_2019$id_paciente)

cd4_oaxaca_2020_2021 <- read_excel("cd4_oaxaca.xlsx") %>% 
  filter(id_paciente%in%capasits_oaxaca_2020_2021$id_paciente)
####################
cv_oaxaca_2018_2021 <- read_excel("carga_viral_oaxaca.xlsx") %>% 
  filter(id_paciente%in%capasits_oaxaca_2018_2021$id_paciente)

cv_oaxaca_2018_2019 <- read_excel("carga_viral_oaxaca.xlsx") %>% 
  filter(id_paciente%in%capasits_oaxaca_2018_2019$id_paciente)

cv_oaxaca_2020_2021 <- read_excel("carga_viral_oaxaca.xlsx") %>% 
  filter(id_paciente%in%capasits_oaxaca_2020_2021$id_paciente)

```

Se recibieron además dos bases adicionales, las cuales incluyen información sobre todas las mediciones de linfocitos T CD4 y carga viral de VIH realizadas en pacientes de CAPASITS Oaxaca. En la base de linfocitos T CD4 (llamada *cd4_oaxaca_2018_2021*) hay información sobre `r n_distinct(cd4_oaxaca_2018_2021$id_paciente)` pacientes, mientras que en la de carga viral de VIH (llamada *cv_oaxaca_2018_2021*) hay información sobre `r n_distinct(cv_oaxaca_2018_2021$id_paciente)` pacientes. De los pacientes presentes en *capasits_oaxaca_2018_2021*, `r n_distinct(filter(cd4_oaxaca_2018_2021, id_paciente%in%capasits_oaxaca_2018_2021$id_paciente)$id_paciente)` (`r round(n_distinct(filter(cd4_oaxaca_2018_2021, id_paciente%in%capasits_oaxaca_2018_2021$id_paciente)$id_paciente)/n_distinct(capasits_oaxaca_2018_2021$id_paciente), 1)`%) tuvieron información sobre linfocitos T CD4 en la base *cd4_oaxaca_2018_2021*. Asimismo,  `r n_distinct(filter(cv_oaxaca_2018_2021, id_paciente%in%capasits_oaxaca_2018_2021$id_paciente)$id_paciente)` (`r round(n_distinct(filter(cv_oaxaca_2018_2021, id_paciente%in%capasits_oaxaca_2018_2021$id_paciente)$id_paciente)/n_distinct(capasits_oaxaca_2018_2021$id_paciente), 1)`%) tuvieron información sobre carga viral de VIH en *cv_oaxaca_2018_2021*. Todos los pacienes con información sobre carga viral también tuvieron información sobre linfocitos T CD4, de manera que hubo `r n_distinct(filter(cd4_oaxaca_2018_2021, id_paciente%in%capasits_oaxaca_2018_2021$id_paciente)$id_paciente)-n_distinct(filter(cv_oaxaca_2018_2021, id_paciente%in%capasits_oaxaca_2018_2021$id_paciente)$id_paciente)` más pacientes con información sobre linfocitos T CD4. En la **Tabla 2** se describen a detalle las características generales de los pacientes incluidos en la base *capasits_oaxaca_2018_2021*

```{r tabla 2, run = F, include = F, warning=F}
#Construiremos las variables que compondrán la tabla por separado para que sea más manejable

capasits_oaxaca_t2 <- capasits_oaxaca_2018_2021 %>% 
  mutate(ano_diagnostico=year(paciente_notificacion),
         ano_ingreso=year(paciente_ingreso))


#Género de los pacientes
year_t <- c("2018", "2019", "2020", "2021", "Todos")

#Tipo de pacientes (todos son en trataimento ARV)
paciente_tipo_t2 <- c(str_c(sum(capasits_oaxaca_t2$ano_ingreso=="2018"), " (", round(sum(capasits_oaxaca_t2$ano_ingreso=="2018")/nrow(capasits_oaxaca_t2), 3)*100, "%)"),
                                      str_c(sum(capasits_oaxaca_t2$ano_ingreso=="2019"), " (", round(sum(capasits_oaxaca_t2$ano_ingreso=="2019")/nrow(capasits_oaxaca_t2), 3)*100, "%)"),
                                      str_c(sum(capasits_oaxaca_t2$ano_ingreso=="2020"), " (", round(sum(capasits_oaxaca_t2$ano_ingreso=="2020")/nrow(capasits_oaxaca_t2), 3)*100, "%)"),
                                      str_c(sum(capasits_oaxaca_t2$ano_ingreso=="2021"), " (", round(sum(capasits_oaxaca_t2$ano_ingreso=="2021")/nrow(capasits_oaxaca_t2), 3)*100, "%)"),
                                      str_c(nrow(capasits_oaxaca_t2), " (100%)"))




#Sexo de los pacientes
paciente_sexo_fem_t2 <- c(str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_sexo=="F"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_sexo=="F")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2018")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_sexo=="F"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_sexo=="F")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2019")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_sexo=="F"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_sexo=="F")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2020")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t2,ano_ingreso=="2021")$paciente_sexo=="F"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2021")$paciente_sexo=="F")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2021")), 3)*100, "%)"),
                           str_c(sum(capasits_oaxaca_t2$paciente_sexo=="F"), " (100%)"))


paciente_sexo_masc_t2 <- c(str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_sexo=="M"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_sexo=="M")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2018")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_sexo=="M"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_sexo=="M")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2019")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_sexo=="M"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_sexo=="M")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2020")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t2,ano_ingreso=="2021")$paciente_sexo=="M"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2021")$paciente_sexo=="M")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2021")), 3)*100, "%)"),
                           str_c(sum(capasits_oaxaca_t2$paciente_sexo=="M"), " (100%)"))


paciente_sexo_mujtrans_t2 <- c(str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_sexo=="TF"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_sexo=="TF")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2018")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_sexo=="TF"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_sexo=="TF")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2019")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_sexo=="TF"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_sexo=="TF")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2020")), 3)*100, "%)"),
                           str_c(sum(filter(capasits_oaxaca_t2,ano_ingreso=="2021")$paciente_sexo=="TF"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2021")$paciente_sexo=="TF")/nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2021")), 3)*100, "%)"),
                           str_c(sum(capasits_oaxaca_t2$paciente_sexo=="TF"), " (100%)"))



#Edad de los pacientes (mediana y rango IQR)
paciente_edad_t2 <- c(str_c(median(filter(capasits_oaxaca_t2, ano_ingreso=="2018"&!is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca_t2, ano_ingreso=="2018"&!is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca_t2, ano_ingreso=="2018"&!is.na(paciente_edad))$paciente_edad)[4], ")"),
                     
                     str_c(median(filter(capasits_oaxaca_t2, ano_ingreso=="2019"&!is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca_t2, ano_ingreso=="2019"&!is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca_t2, ano_ingreso=="2019"&!is.na(paciente_edad))$paciente_edad)[4], ")"),
                     
                     str_c(median(filter(capasits_oaxaca_t2, ano_ingreso=="2020"&!is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca_t2, ano_ingreso=="2020"&!is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca_t2, ano_ingreso=="2020"&!is.na(paciente_edad))$paciente_edad)[4], ")"),
                     
                     str_c(median(filter(capasits_oaxaca_t2, ano_ingreso=="2021"&!is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca_t2, ano_ingreso=="2021"&!is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca_t2, ano_ingreso=="2021"&!is.na(paciente_edad))$paciente_edad)[4], ")"),
                     
                     str_c(median(filter(capasits_oaxaca_t2, !is.na(paciente_edad))$paciente_edad), " (", fivenum(filter(capasits_oaxaca_t2, !is.na(paciente_edad))$paciente_edad)[2],
                           "-", fivenum(filter(capasits_oaxaca_t2, !is.na(paciente_edad))$paciente_edad)[4], ")"))


#Si la paciente estaba o no embarazada
paciente_embarazada_t2 <- c(str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_vih_embarazada=="SI"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_vih_embarazada=="SI")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2018"&paciente_sexo=="F")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_vih_embarazada=="SI"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_vih_embarazada=="SI")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2019"&paciente_sexo=="F")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_vih_embarazada=="SI"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_vih_embarazada=="SI")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2020"&paciente_sexo=="F")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2,ano_ingreso=="2021")$paciente_vih_embarazada=="SI"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2021")$paciente_vih_embarazada=="SI")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2021"&paciente_sexo=="F")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t2$paciente_vih_embarazada=="SI"), " (", 
                                 round(sum(capasits_oaxaca_t2$paciente_vih_embarazada=="SI")/
                                         sum(capasits_oaxaca_t2$paciente_sexo=="F"), 3)*100, "%)"))

#Si la paciente estaba privada de su libertad

paciente_privada_t2 <- c(str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_priv_libertad=="S"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_priv_libertad=="S")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2018")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_priv_libertad=="S"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_priv_libertad=="S")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2019")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_priv_libertad=="S"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_priv_libertad=="S")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2020")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2,ano_ingreso=="2021")$paciente_priv_libertad=="S"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2021")$paciente_priv_libertad=="S")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2021")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t2$paciente_priv_libertad=="S"), " (", 
                                 round(sum(capasits_oaxaca_t2$paciente_priv_libertad=="S")/
                                         nrow(capasits_oaxaca_t2), 3)*100, "%)"))


#Si los pacientes tenían estatus de activo, desglosado por género
paciente_estatus_activo_t2 <- c(str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_estatus=="ACTIVO"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_estatus=="ACTIVO")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2018")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_estatus=="ACTIVO"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_estatus=="ACTIVO")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2019")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_estatus=="ACTIVO"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_estatus=="ACTIVO")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2020")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2,ano_ingreso=="2021")$paciente_estatus=="ACTIVO"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2021")$paciente_estatus=="ACTIVO")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2021")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t2$paciente_estatus=="ACTIVO"), " (", 
                                 round(sum(capasits_oaxaca_t2$paciente_estatus=="ACTIVO")/
                                         nrow(capasits_oaxaca_t2), 3)*100, "%)"))
  
  
  
 

#Si los pacientes tenían estatus de baja, desglosado por género
paciente_estatus_baja_t2 <- c(str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_estatus=="BAJA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_estatus=="BAJA")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2018")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_estatus=="BAJA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_estatus=="BAJA")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2019")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_estatus=="BAJA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_estatus=="BAJA")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2020")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2,ano_ingreso=="2021")$paciente_estatus=="BAJA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2021")$paciente_estatus=="BAJA")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2021")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t2$paciente_estatus=="BAJA"), " (", 
                                 round(sum(capasits_oaxaca_t2$paciente_estatus=="BAJA")/
                                         nrow(capasits_oaxaca_t2), 3)*100, "%)"))


#Si los pacientes tenían estatus de derivación, desglosado por género

paciente_estatus_derivacion_t2 <- c(str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2018")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2019")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2020")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2,ano_ingreso=="2021")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2021")$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2021")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t2$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA"), " (", 
                                 round(sum(capasits_oaxaca_t2$paciente_estatus=="EN DERIVACION DERECHOHABIENCIA")/
                                         nrow(capasits_oaxaca_t2), 3)*100, "%)"))
  
  
  

#Si los pacientes tenían estatus de suspensión, desglosado por género
paciente_estatus_suspension_t2 <- c(str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_estatus=="EN SUSPENSION"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_estatus=="EN SUSPENSION")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2018")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_estatus=="EN SUSPENSION"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_estatus=="EN SUSPENSION")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2019")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_estatus=="EN SUSPENSION"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_estatus=="EN SUSPENSION")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2020")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2,ano_ingreso=="2021")$paciente_estatus=="EN SUSPENSION"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2021")$paciente_estatus=="EN SUSPENSION")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2021")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t2$paciente_estatus=="EN SUSPENSION"), " (", 
                                 round(sum(capasits_oaxaca_t2$paciente_estatus=="EN SUSPENSION")/
                                         nrow(capasits_oaxaca_t2), 3)*100, "%)"))
  
  


#Tratamiento para incluir en la tabla
 tratamiento_t2 <- group_by(capasits_oaxaca_t2, ano_ingreso, esquema) %>% 
   count() %>% 
   arrange(desc(n)) %>% 
   ungroup() %>% 
   group_by(ano_ingreso) %>% 
   slice(1)

tratamiento_whole_t2 <- group_by(capasits_oaxaca_t2, esquema) %>% 
  count() %>% 
  arrange(desc(n)) 


tratamiento_tab2 <- c(str_c(tratamiento_t2$esquema, " ", tratamiento_t2$n), str_c(tratamiento_whole_t2$esquema[1], " ", tratamiento_whole_t2$n[1]))

#Centro en donde reciben la atención
centro_oaxaca_t2 <- c(str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_sai=="CAPASITS - Oaxaca"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_sai=="CAPASITS - Oaxaca")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2018")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_sai=="CAPASITS - Oaxaca"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_sai=="CAPASITS - Oaxaca")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2019")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_sai=="CAPASITS - Oaxaca"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_sai=="CAPASITS - Oaxaca")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2020")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2,ano_ingreso=="2021")$paciente_sai=="CAPASITS - Oaxaca"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2021")$paciente_sai=="CAPASITS - Oaxaca")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2021")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t2$paciente_sai=="CAPASITS - Oaxaca"), " (", 
                                 round(sum(capasits_oaxaca_t2$paciente_sai=="CAPASITS - Oaxaca")/
                                         nrow(capasits_oaxaca_t2), 3)*100, "%)"))
  



centro_salina_t2 <- c(str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_sai=="CAPASITS - Salina Cruz"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2018")$paciente_sai=="CAPASITS - Salina Cruz")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2018")), 3)*100, "%)"),
                          #  
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_sai=="CAPASITS - Salina Cruz"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2019")$paciente_sai=="CAPASITS - Salina Cruz")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2019")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_sai=="CAPASITS - Salina Cruz"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2020")$paciente_sai=="CAPASITS - Salina Cruz")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2020")), 3)*100, "%)"),
                           #
                           str_c(sum(filter(capasits_oaxaca_t2,ano_ingreso=="2021")$paciente_sai=="CAPASITS - Salina Cruz"), " (", 
                                 round(sum(filter(capasits_oaxaca_t2, ano_ingreso=="2021")$paciente_sai=="CAPASITS - Salina Cruz")/
                                         nrow(filter(capasits_oaxaca_t2, ano_ingreso=="2021")), 3)*100, "%)"),
                           #
                           str_c(sum(capasits_oaxaca_t2$paciente_sai=="CAPASITS - Salina Cruz"), " (", 
                                 round(sum(capasits_oaxaca_t2$paciente_sai=="CAPASITS - Salina Cruz")/
                                         nrow(capasits_oaxaca_t2), 3)*100, "%)"))

####TABLA 2 
table_2 <- data.frame(ano_ingreso=year_t,
                      #####################
                      paciente_tipo=paciente_tipo_t2,
                      #####################
                      paciente_sexo=rep("-", times=5),
                      #####################
                      paciente_sexo_mujer=paciente_sexo_fem_t2,
                      #####################
                      paciente_sexo_masc=paciente_sexo_masc_t2,
                      #####################
                      paciente_sexo_mujtrans=paciente_sexo_mujtrans_t2,
                      #####################
                      paciente_edad=paciente_edad_t2,
                      #####################
                      paciente_embarazada=paciente_embarazada_t2,
                      #####################
                      paciente_privada_libertad=paciente_privada_t2,
                      #####################
                      paciente_estatus=rep("-", times=5),
                      #####################
                      paciente_estatus_activo=paciente_estatus_activo_t2,
                      #####################
                      paciente_estatus_baja=paciente_estatus_baja_t2,
                      #####################
                      paciente_estatus_en_derivacion=paciente_estatus_derivacion_t2,
                      #####################
                      paciente_estatus_suspension=paciente_estatus_suspension_t2,
                      #####################
                      paciente_tratamiento= tratamiento_tab2,
                      #####################
                      paciente_centro=rep("-", times=5),
                      #####################
                      paciente_centro_oaxaca= centro_oaxaca_t2,
                      #####################
                      paciente_centro_salina=centro_salina_t2
                      )


View(table_2)


```

```{r pacientes y sexo, run = F, include = F, warning = F}
#####ANÁLISIS DE BASE PRELIMINAR

######La base quedó con el nombre'epi_oaxaca'
glimpse(capasits_oaxaca)

######Número de filas
nrow(capasits_oaxaca)

######Número de identificadores diferentes
n_distinct(capasits_oaxaca$id_paciente)
#Hay 5921 filas y 5920 identificadores diferentes
glimpse(capasits_oaxaca %>% 
  group_by(id_paciente) %>% 
    count() %>% 
  arrange(desc(n)))[1,1] 
#51151 es el paciente que se repite
glimpse(filter(capasits_oaxaca, id_paciente == 51151))#Únicamente difieren en el esquema de ART que está utilizando, por lo pronto no lo eliminaré

######Pacientes en tratamiento ART ('paciente_tipo' según la variable de la base)
table(capasits_oaxaca$paciente_tipo)
#Al parecer todos los pacientes están clasificados como en tratamiento antirretroviral

######Sexo 
table(capasits_oaxaca$paciente_sexo)

#Únicamente confirmar que 'TF' signifique mujer trans y que 'TM' signifique hombre trans
```

```{r include= T, run = F}
#La base cuenta con una fila por paciente y una columna por variable, con solo un paciente repetido (aquel con el identificador `r glimpse(epi_oaxaca %>%group_by(id_paciente) %>% count() %>%arrange(desc(n)))[1,1]`). Las variables incluidas son las siguientes: `r names(epi_oaxaca)`.  

#Según se puede inferir de la base, incluye la información más actualizada al momento en el cual se generó. Es decir, incluye algunas características basales(por ejemplo, 'fecha de ingreso') y otras que corresponden a la última medición para una variable determinada (por ejemplo, 'cd4 resultado').
```

```{r base oaxaca v1, run = F, include = F, warning = F}
#####Edad
fivenum(capasits_oaxaca$paciente_edad)
nrow(filter(capasits_oaxaca, paciente_edad>=18))
nrow(filter(capasits_oaxaca, paciente_edad>=18))/nrow(capasits_oaxaca)
#Prácticamente todos son mayores de edad
#La distribución de la edad parece razonable, pero si se puede lo mejor sería que nos dieran la fecha de nacimiento, desconozco cuándo y cómo actualicen la edad de los pacientes


#####Pacientes con VIH que están embarazadas (habría que preguntar exactamente cómo definen esta variable y con qué frecuencia la actualizan)
table(capasits_oaxaca$paciente_vih_embarazada)
#Descartar que haya errores de código en cuanto a sexo
table(EMBARAZADA = capasits_oaxaca$paciente_vih_embarazada,
      SEXO = capasits_oaxaca$paciente_sexo)
#Parece que al hombre trans lo pusieron como 'NO APLICA'. Es un detalle pequeño, pero creo que valdría la pena que actualizaran esta codificación en su estado porque el término preferido actual es 'personas con capacidad de gestar' (nada más confirmar que por el hecho de ser trans no les asignen la variable de 'NO APLICA')
#Hay 73 hombres que se clasificaron como 'NO' embarazadas, verificar si esto simplemente fue por error al meter los datos (ej. no sabían que se tenían que poner en 'NO APLICA' o si son hombres trans)


######Última consulta
range(capasits_oaxaca$paciente_ultima_consulta)#Hay pacientes sin info en última consulta
sum(is.na(capasits_oaxaca$paciente_ultima_consulta))#Solo es uno
glimpse(filter(capasits_oaxaca, is.na(paciente_ultima_consulta)))
#Parece que si tiene último estatus, nomás no tiene fecha de última consulta, según los datos parece que en cuanto se captó se sacó del programa porque tenía ISSSTE, por el momento no creo que haya que excluirlo

range(capasits_oaxaca$paciente_ultima_consulta[!is.na(capasits_oaxaca$paciente_ultima_consulta)])#Fecha de última consulta con rango implausible
range(capasits_oaxaca$paciente_ultima_consulta[!is.na(capasits_oaxaca$paciente_ultima_consulta)&
                                            capasits_oaxaca$paciente_ultima_consulta>="2000-01-01"])#Última fecha de consulta introducida en la base con la fecha más temprana (aparentemente real que no parece un error de codificación) en 2005

nrow(filter(capasits_oaxaca, paciente_ultima_consulta>="2000-01-01"))#Únicamente dos pacientes con fecha de consulta previo a este año, uno de los cuales es el paciente con valor faltante en esa variable

#La mayoría de pacientes tuvieron su última consulta en 2021
epi_consulta <- mutate(capasits_oaxaca, year_ultima_consulta=year(paciente_ultima_consulta)) %>% 
  group_by(year_ultima_consulta) %>% 
  count() %>% 
  mutate(year_ultima_consulta=as.factor(year_ultima_consulta))

epi_consulta$n[epi_consulta$year_ultima_consulta ==2021]/sum(epi_consulta$n)
#Dos tercios de pacientes tuvieron su última consulta en 2021
ggplot(epi_consulta, aes(y=year_ultima_consulta, x = n))+
  theme_bw()+
  ggtitle("Año de última consulta en COESIDA de personas que viven con VIH")+
  ylab("Año de última consulta")+
  xlab("Número de pacientes")+
  geom_segment(aes(yend = year_ultima_consulta), xend=0, colour="grey50", size = 1.5)+  
  geom_point(size = 3.5, colour = "red")+
  scale_x_continuous(breaks= seq(from = 0, to = 4000, by =250))+
  theme(axis.text.x = element_text(angle=30))
  

######Pacientes privados de su libertad
table(capasits_oaxaca$paciente_priv_libertad)
#Pocos pacientes privados de su libertad
table(PRIVADOS_LIBERTAD=capasits_oaxaca$paciente_priv_libertad,
      SEXO=capasits_oaxaca$paciente_sexo)
#Distinción por sexo, a destacar que parece que no hay pacientes trans, lo cual podría significar a su vez algo bastante malo


######Paciente notificación. No estoy seguro que significa, será la fecha de diagnóstico?
range(capasits_oaxaca$paciente_notificacion)#Algunos no tienen ese dato
sum(is.na(capasits_oaxaca$paciente_notificacion))#Sólo 4
glimpse(filter(capasits_oaxaca, is.na(paciente_notificacion)))#No encuentro una causa obvia para la falta de este dato, supongo que fue únicamente error al meter la información
range(capasits_oaxaca$paciente_notificacion[!is.na(capasits_oaxaca$paciente_notificacion)])#Primera fecha de notificación en 1984, no creo que sea esta la fecha del primer caso de VIH en oaxaca, o sí? Habría que revisar

epi_notificacion <- mutate(capasits_oaxaca, year_paciente_notificacion=year(paciente_notificacion)) %>% 
  group_by(year_paciente_notificacion) %>% 
  count() %>% 
  mutate(year_paciente_notificacion=as.factor(year_paciente_notificacion))

epi_notificacion$n[epi_notificacion$year_paciente_notificacion ==2021]/sum(epi_notificacion$n)
#Sólo 7% se notificaron en 2021, supongo que si es la fecha de diagnóstico, pero habría que confirmar con quienes armaron la base
ggplot(epi_notificacion, aes(y=year_paciente_notificacion, x = n))+
  theme_bw()+
  ggtitle("Año de notificación (diagnóstico?) de personas que viven con VIH en Oaxaca")+
  ylab("Año de notificación")+
  xlab("Número de pacientes")+
  geom_segment(aes(yend = year_paciente_notificacion), xend=0, colour="grey50", size = 1.5)+  
  geom_point(size = 3.5, colour = "red")+
  scale_x_continuous(breaks= seq(from = 0, to = 500, by =50))+
  theme(axis.text.x = element_text(angle=30))


#####Paciente ingreso
range(capasits_oaxaca$paciente_ingreso)#Algunos no tienen ese dato
sum(is.na(capasits_oaxaca$paciente_ingreso))#Sólo 14
glimpse(filter(capasits_oaxaca, is.na(paciente_ingreso)))#No encuentro una causa obvia para la falta de este dato, supongo que fue únicamente error al meter la información
range(capasits_oaxaca$paciente_ingreso[!is.na(capasits_oaxaca$paciente_ingreso)])#Primera fecha de ingreso en 1994, este año se fundó COESIDA entonces supongo que si es únicamente referente a este servicio

epi_ingreso <- mutate(capasits_oaxaca, paciente_ingreso=year(paciente_ingreso)) %>% 
  group_by(paciente_ingreso) %>% 
  count() %>% 
  mutate(paciente_ingreso=as.factor(paciente_ingreso))

epi_ingreso$n[epi_ingreso$paciente_ingreso ==2021]/sum(epi_ingreso$n)
#Sólo 7% ingresaron en 2021 (igual que el número de notificaciones/diagnósticos)

ggplot(epi_ingreso, aes(y=paciente_ingreso, x = n))+
  ggtitle("Año de ingreso a COESIDA de personas que viven con VIH")+
  theme_bw()+
  ylab("Año de ingreso")+
  xlab("Número de pacientes")+
  geom_segment(aes(yend = paciente_ingreso), xend=0, colour="grey50", size = 1.5)+  
  geom_point(size = 3.5, colour = "red")+
  scale_x_continuous(breaks= seq(from = 0, to = 500, by =50))+
  theme(axis.text.x = element_text(angle=30))
#Parece que ninguno se inactivó por la pandemia, al menos durante algún año completo


#####Paciente SAI (centro de atención)
table(capasits_oaxaca$paciente_sai)
#Parece que sólo hay dos centros

#Aquí quiero ver si los dos han estado siempre activos o si francamente alguno dejó de recibir pacientes en algún momento
epi_sai <- mutate(capasits_oaxaca, paciente_ingreso=year(paciente_ingreso)) %>% 
  group_by(paciente_sai, paciente_ingreso) %>% 
  count() %>% 
  mutate(paciente_ingreso=as.factor(paciente_ingreso))


ggplot(epi_sai, aes(y=paciente_ingreso, x = n, fill = paciente_sai))+
  ggtitle("Año de ingreso a COESIDA según SAI")+
  theme_bw()+
  ylab("Año de ingreso")+
  xlab("Número de pacientes")+
  geom_col(position=position_dodge(0.5), colour = "black")+  
  scale_x_continuous(breaks= seq(from = 0, to = 500, by =50))+
  theme(axis.text.x = element_text(angle=30))
#Parece que ningún SAI dejó de funcionar (al menos durante un periodo prolongado)


#####Paciente fecha alta 
sum(is.na(capasits_oaxaca$paciente_fecha_alta))
#parece que todos tienen este dato. ¿A qué se refieren con fecha de alta? Definitivamente no es alta médica, ya que todas las persoans lo tienen, tampoco es fecha de ingreso porque difiere a la otra en las fechas
range(capasits_oaxaca$paciente_fecha_alta)


######Estatus de los pacientes
table(capasits_oaxaca$paciente_estatus)
#Habría que preguntar qué significan los siguientes dos estatus:
#'EN DERIVACION DERECHOHABIENCIA"
#'EN SUSPENSION'
#Además, cuáles son los criterios para cada uno de los estados. ¿Cambiaron estos criterios con la pandemia? ¿Hubo algún periodo de inactividad en el cual no se actualizó el estatus de los pacientes (o peor, que el sistema de atención se mantuvo inactivo, al menos durante algunas semanas-meses)?


#####Paciente causa baja
table(capasits_oaxaca$paciente_causa_baja)
#Cómo determinan que alguien se da de alta médica? Formalmente una persona que vive con VIH nunca está de alta médica. Cómo definieron abandono? Es posible que estos abandonos sean defunciones o migraciones no detectadas?


#####Paciente fecha de defunción
sum(!is.na(capasits_oaxaca$paciente_fecha_defuncion))
#Este número (658) difiere al número de defunciones totales que tienen registradas (848), hay algún motivo por el cuál no se tenga la fecha de defunción?
table(DEFUNCION_CON_FECHA=!is.na(capasits_oaxaca$paciente_fecha_defuncion),
      CAUSA_DE_BAJA=capasits_oaxaca$paciente_causa_baja)
#Aquí nomás podemos reclasificar a un paciente que tiene como causa de baja "ABANDONO" pero tiene una fecha de muerte
#Quizá con la fecha de último estatus


#Fecha de últimop estatus
range(capasits_oaxaca$paciente_f_ultimo_estatus)
#Todos tienen este dato, alguno de los que fallecieron tendrá una fecha posterior a la de muerte (o viceversa)?

nrow(filter(capasits_oaxaca, (!is.na(paciente_fecha_defuncion)|paciente_causa_baja=="DEFUNCION")& paciente_f_ultimo_estatus>paciente_fecha_defuncion))
#641 de quienes fallecieron tienen una fecha de úlimo estatus posterior a la fecha de muerte, en qué consta la fecha de últimoe estatus?

nrow(filter(capasits_oaxaca, (!is.na(paciente_fecha_defuncion)|paciente_causa_baja=="DEFUNCION")& paciente_f_ultimo_estatus<paciente_fecha_defuncion))
#Sólo 5 tienen una fecha de muerte posterior a la de último estatus, esto es más fácil de explicar y corregir


#Esquema fecha inicio
range(capasits_oaxaca$esquema_fecha_inicio)#Personas sin ese dato
sum(is.na(capasits_oaxaca$esquema_fecha_inicio))#Sólo 70, tienen perdida la fecha de inicio de esquema o realmente nunca lo iniciaron?
glimpse(filter(capasits_oaxaca, is.na(capasits_oaxaca$esquema_fecha_inicio)))
#Sería interesante, una vez confirmado que la variable "paciente notificacion" corresponda a la fecha de diagnóstico, analizar cuánto tiempo tardaron en iniciar ARV desde el diagnóstico (que será lo que haremos con los datos de ccasanet, de aceptarlo Sierra, Brenda, y los demás de ccasanet)


#####CD4
sum(is.na(capasits_oaxaca$cd4_resultado))#270 nunca han tenido una toma de CD4 (quiero pensar que el valor incluido en esta base es el último para cada persona)
#Sería estupendo que nos pasaran el resto de los CD4 para cada persona (igual que la CV)


#####Carga viral
sum(is.na(capasits_oaxaca$cv_no_copias))#304 nunca han tenido una cv, por qué difiere este número al de linfocitos CD4?

```

```{r base capasits, eval= F, run = F, warning=F, include= F}
plantilla_capasits <- plantilla_capasits %>% 
  mutate(paciente_ultima_consulta= ymd(paciente_ultima_consulta),
         paciente_notificacion= ymd(paciente_notificacion),
         paciente_ingreso=ymd(paciente_ingreso),
         paciente_fecha_alta=ymd(paciente_fecha_alta),
         paciente_f_ultimo_estatus=ymd(substr(paciente_f_ultimo_estatus, 1, 10)),
         esquema_fecha_inicio=ymd(esquema_fecha_inicio),
         cd4_fecha_estudio=ymd(cd4_fecha_estudio),
         cv_fecha_estudio=ymd(cv_fecha_estudio)) 

nrow(plantilla_capasits)

plantilla_capasits_filtrada <- filter(plantilla_capasits, (paciente_f_ultimo_estatus>="2018-01-01"|
                 esquema_fecha_inicio>="2018-01-01"|
                 paciente_ingreso>="2018-01-01"|
                 paciente_notificacion>="2018-01-01"|
                 paciente_ultima_consulta>="2018-01-01"|
                 cd4_fecha_estudio>="2018-01-01"|
                 cv_fecha_estudio>="2018-01-01"|
                   paciente_fecha_alta>="2018-01-01")&
                   (is.na(paciente_fecha_defuncion)|
                   (!is.na(paciente_fecha_defuncion)&paciente_fecha_defuncion>="2018-01-01")))


nrow(plantilla_capasits_filtrada)

nrow(filter(plantilla_capasits_filtrada, paciente_f_ultimo_estatus<"2018-01-01"&
                 esquema_fecha_inicio<"2018-01-01"&
                 paciente_ingreso<"2018-01-01"&
                 paciente_notificacion<"2018-01-01"&
                 paciente_ultima_consulta<"2018-01-01"&
                 cd4_fecha_estudio<"2018-01-01"&
                 cv_fecha_estudio<"2018-01-01"&
                   paciente_fecha_alta<"2018-01-01"&
              (is.na(paciente_fecha_defuncion)|!is.na(paciente_fecha_defuncion)&paciente_fecha_defuncion<"2018-01-01")))

#write.csv(plantilla_capasits_filtrada, "./plantilla_capasits_filtrada.csv", row.names=T)
```

